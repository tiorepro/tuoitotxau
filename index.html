<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Công cụ Chọn Tuổi Xông Đất (Hoàn Chỉnh)</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; line-height: 1.6; margin: 0; padding: 20px; background-color: #f4f4f4; color: #333; }
        .container { max-width: 900px; margin: auto; background: #fff; padding: 25px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1, h2 { text-align: center; color: #2c3e50; }

        /* Tab Navigation Styles */
        .tab-nav { overflow: hidden; border-bottom: 2px solid #ccc; margin-bottom: 20px; }
        .tab-nav button { background-color: inherit; float: left; border: none; outline: none; cursor: pointer; padding: 14px 16px; transition: 0.3s; font-size: 1.1em; font-weight: bold; color: #34495e; }
        .tab-nav button:hover { background-color: #f1f1f1; }
        .tab-nav button.active { background-color: #3498db; color: white; border-radius: 5px 5px 0 0; }
        
        .tab-content { display: none; animation: fadeEffect 0.5s; }
        @keyframes fadeEffect { from {opacity: 0;} to {opacity: 1;} }

        .input-section { display: flex; flex-direction: column; align-items: center; gap: 15px; margin-bottom: 30px; }
        .button-group { display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; }
        label { font-weight: bold; font-size: 1.1em; }
        select, button { padding: 12px 18px; border-radius: 5px; border: 1px solid #ccc; font-size: 1em; cursor: pointer; transition: background-color 0.2s ease; }
        button.action-btn { background-color: #3498db; color: white; border: none; }
        button.action-btn:hover { background-color: #2980b9; }
        button.action-btn.bad { background-color: #c0392b; }
        button.action-btn.bad:hover { background-color: #a93226; }
        button.action-btn.all { background-color: #7f8c8d; }
        button.action-btn.all:hover { background-color: #626f70; }
        button.export-btn { margin-top: 15px; display: none; }
        button#exportGoodButton { background-color: #27ae60; color: white; border: none; }
        button#exportGoodButton:hover { background-color: #229954; }
        button#exportBadButton { background-color: #e74c3c; color: white; border: none; }
        button#exportBadButton:hover { background-color: #c0392b; }

        .results-header-container { text-align: center; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 12px; border: 1px solid #ddd; text-align: left; vertical-align: top; }
        th { background-color: #ecf0f1; font-weight: bold; }
        .rank { font-weight: bold; text-align: center; }
        .score { font-weight: bold; color: #e74c3c; text-align: center; }
        .details ul { padding-left: 20px; margin: 0; font-size: 0.9em; }
        .details li { margin-bottom: 4px; }
        .penalty { color: #c0392b; font-style: italic; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color: #fefefe; margin: 5% auto; padding: 20px; border: 1px solid #888; width: 90%; max-width: 700px; border-radius: 8px; }
        .close-button { color: #aaa; float: right; font-size: 28px; font-weight: bold; }
        .close-button:hover, .close-button:focus { color: black; text-decoration: none; cursor: pointer; }
        #exportTextarea { width: 100%; height: 450px; margin-top: 15px; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; font-size: 15px; line-height: 1.6; white-space: pre-wrap; word-wrap: break-word; box-sizing: border-box; border: 1px solid #ccc; padding: 10px; }
    </style>
</head>
<body>

    <div class="container">
        <h1>Công cụ Phong Thủy</h1>

        <!-- Master Tab Navigation -->
        <div class="tab-nav">
            <button class="tab-link" onclick="openTab(event, 'tabTuoiTotXau')">TUỔI TỐT/XẤU TRONG NĂM</button>
            <button class="tab-link" onclick="openTab(event, 'tabDinhLuong')">ĐỊNH LƯỢNG TƯƠNG TÁC</button>
        </div>

        <!-- Master Tab Content -->
        <div id="tabTuoiTotXau" class="tab-content">
            <div class="input-section">
                <label for="yearSelect">Chọn năm cần xem:</label>
                <select id="yearSelect"></select>
                <div class="button-group">
                    <button id="viewGoodButton" class="action-btn">Xem 10 Tuổi Tốt Nhất</button>
                    <button id="viewBadButton" class="action-btn bad">Xem 10 Tuổi Xấu Nhất</button>
                    <button id="viewAllButton" class="action-btn all">Xem Bảng 60 Hoa Giáp</button>
                </div>
            </div>
            <div class="results-header-container">
                <h2 id="resultsHeader"></h2>
                <button id="exportGoodButton" class="export-btn">Xuất Kết Quả Tốt</button>
                <button id="exportBadButton" class="export-btn bad">Xuất Danh Sách Xấu</button>
            </div>
            <div style="overflow-x:auto;">
                <table>
                    <thead>
                        <tr>
                            <th>Hạng</th>
                            <th>Tuổi</th>
                            <th>Mệnh</th>
                            <th>Điểm</th>
                            <th>Chi Tiết</th>
                        </tr>
                    </thead>
                    <tbody id="resultsBody"></tbody>
                </table>
            </div>
        </div>

        <div id="tabDinhLuong" class="tab-content">
            <h2>Chức năng Định Lượng Tương Tác</h2>
            <p>Khu vực này được dành để phát triển các chức năng tính toán, định lượng mới trong tương lai.</p>
        </div>
        
    </div>

    <!-- Modal (shared) -->
    <div id="exportModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2 id="modalHeader"></h2>
            <textarea id="exportTextarea" readonly></textarea>
        </div>
    </div>

    <script>
        // DATA SETS - USING USER'S PROVIDED TABLE EXACTLY
        const hoaGiap = [
            { can: "Giáp", chi: "Tý", menh: "Hải Trung Kim" }, { can: "Ất", chi: "Sửu", menh: "Hải Trung Kim" }, { can: "Bính", chi: "Dần", menh: "Giáng Hạ Thủy" }, { can: "Đinh", chi: "Mão", menh: "Giáng Hạ Thủy" }, { can: "Mậu", chi: "Thìn", menh: "Đại Lâm Mộc" }, { can: "Kỷ", chi: "Tị", menh: "Đại Lâm Mộc" }, { can: "Canh", chi: "Ngọ", menh: "Lộ Bàng Thổ" }, { can: "Tân", chi: "Mùi", menh: "Lộ Bàng Thổ" }, { can: "Nhâm", chi: "Thân", menh: "Kiếm Phong Kim" }, { can: "Quý", chi: "Dậu", menh: "Kiếm Phong Kim" }, { can: "Giáp", chi: "Tuất", menh: "Tuyền Trung Thủy" }, { can: "Ất", chi: "Hợi", menh: "Tuyền Trung Thủy" }, { can: "Bính", chi: "Tý", menh: "Lư Trung Hỏa" }, { can: "Đinh", chi: "Sửu", menh: "Lư Trung Hỏa" }, { can: "Mậu", chi: "Dần", menh: "Thành Đầu Thổ" }, { can: "Kỷ", chi: "Mão", menh: "Thành Đầu Thổ" }, { can: "Canh", chi: "Thìn", menh: "Bạch Lạp Kim" }, { can: "Tân", chi: "Tị", menh: "Bạch Lạp Kim" }, { can: "Nhâm", chi: "Ngọ", menh: "Dương Liễu Mộc" }, { can: "Quý", chi: "Mùi", menh: "Dương Liễu Mộc" }, { can: "Giáp", chi: "Thân", menh: "Sơn Đầu Hỏa" }, { can: "Ất", chi: "Dậu", menh: "Sơn Đầu Hỏa" }, { can: "Bính", chi: "Tuất", menh: "Ốc Thượng Thổ" }, { can: "Đinh", chi: "Hợi", menh: "Ốc Thượng Thổ" }, { can: "Mậu", chi: "Tý", menh: "Trường Lưu Thủy" }, { can: "Kỷ", chi: "Sửu", menh: "Trường Lưu Thủy" }, { can: "Canh", chi: "Dần", menh: "Tùng Bách Mộc" }, { can: "Tân", chi: "Mão", menh: "Tùng Bách Mộc" }, { can: "Nhâm", chi: "Thìn", menh: "Tích Lịch Hỏa" }, { can: "Quý", chi: "Tị", menh: "Tích Lịch Hỏa" }, { can: "Giáp", chi: "Ngọ", menh: "Sa Trung Kim" }, { can: "Ất", chi: "Mùi", menh: "Sa Trung Kim" }, { can: "Bính", chi: "Thân", menh: "Thiên Hà Thủy" }, { can: "Đinh", chi: "Dậu", menh: "Thiên Hà Thủy" }, { can: "Mậu", chi: "Tuất", menh: "Bình Địa Mộc" }, { can: "Kỷ", chi: "Hợi", menh: "Bình Địa Mộc" }, { can: "Canh", chi: "Tý", menh: "Bích Thượng Thổ" }, { can: "Tân", chi: "Sửu", menh: "Bích Thượng Thổ" }, { can: "Nhâm", chi: "Dần", menh: "Kim Bạch Kim" }, { can: "Quý", chi: "Mão", menh: "Kim Bạch Kim" }, { can: "Giáp", chi: "Thìn", menh: "Đại Khê Thủy" }, { can: "Ất", chi: "Tị", menh: "Đại Khê Thủy" }, { can: "Bính", chi: "Ngọ", menh: "Sơn Hạ Hỏa" }, { can: "Đinh", chi: "Mùi", menh: "Sơn Hạ Hỏa" }, { can: "Mậu", chi: "Thân", menh: "Đại Dịch Thổ" }, { can: "Kỷ", chi: "Dậu", menh: "Đại Dịch Thổ" }, { can: "Canh", chi: "Tuất", menh: "Thoa Xuyến Kim" }, { can: "Tân", chi: "Hợi", menh: "Thoa Xuyến Kim" }, { can: "Nhâm", chi: "Tý", menh: "Tang Đố Mộc" }, { can: "Quý", chi: "Sửu", menh: "Tang Đố Mộc" }, { can: "Giáp", chi: "Dần", menh: "Phúc Đăng Hỏa" }, { can: "Ất", chi: "Mão", menh: "Phúc Đăng Hỏa" }, { can: "Bính", chi: "Thìn", menh: "Sa Trung Thổ" }, { can: "Đinh", chi: "Tị", menh: "Sa Trung Thổ" }, { can: "Mậu", chi: "Ngọ", menh: "Đại Hải Thủy" }, { can: "Kỷ", chi: "Mùi", menh: "Đại Hải Thủy" }, { can: "Canh", chi: "Thân", menh: "Thạch Lựu Mộc" }, { can: "Tân", chi: "Dậu", menh: "Thạch Lựu Mộc" }, { can: "Nhâm", chi: "Tuất", menh: "Thiên Thượng Hỏa" }, { can: "Quý", chi: "Hợi", menh: "Thiên Thượng Hỏa" }
        ].map((item, index) => ({ ...item, name: `${item.can} ${item.chi}`, index: index }));
        
        const canAmDuong = { "Giáp": "Dương", "Bính": "Dương", "Mậu": "Dương", "Canh": "Dương", "Nhâm": "Dương", "Ất": "Âm", "Đinh": "Âm", "Kỷ": "Âm", "Tân": "Âm", "Quý": "Âm" };
        const tienThienCanHanh = { "Giáp": "Mộc", "Ất": "Mộc", "Bính": "Hỏa", "Đinh": "Hỏa", "Mậu": "Thổ", "Kỷ": "Thổ", "Canh": "Kim", "Tân": "Kim", "Nhâm": "Thủy", "Quý": "Thủy" };
        const hauThienHopPairs = { "Giáp": "Kỷ", "Kỷ": "Giáp", "Ất": "Canh", "Canh": "Ất", "Bính": "Tân", "Tân": "Bính", "Đinh": "Nhâm", "Nhâm": "Đinh", "Mậu": "Quý", "Quý": "Mậu" };
        const hauThienCanHanh = { "Giáp": "Thủy", "Kỷ": "Thủy", "Ất": "Hỏa", "Canh": "Hỏa", "Bính": "Mộc", "Tân": "Mộc", "Đinh": "Kim", "Nhâm": "Kim", "Mậu": "Thổ", "Quý": "Thổ" };
        
        const menhToHanh = {
            "Hải Trung Kim": "Kim", "Kiếm Phong Kim": "Kim", "Bạch Lạp Kim": "Kim", "Sa Trung Kim": "Kim", "Kim Bạc Kim": "Kim", "Thoa Xuyến Kim": "Kim",
            "Đại Lâm Mộc": "Mộc", "Dương Liễu Mộc": "Mộc", "Tùng Bách Mộc": "Mộc", "Bình Địa Mộc": "Mộc", "Tang Đố Mộc": "Mộc", "Thạch Lựu Mộc": "Mộc",
            "Giáng Hạ Thủy": "Thủy", "Tuyền Trung Thủy": "Thủy", "Trường Lưu Thủy": "Thủy", "Thiên Hà Thủy": "Thủy", "Đại Khê Thủy": "Thủy", "Đại Hải Thủy": "Thủy",
            "Lư Trung Hỏa": "Hỏa", "Sơn Đầu Hỏa": "Hỏa", "Tích Lịch Hỏa": "Hỏa", "Sơn Hạ Hỏa": "Hỏa", "Phúc Đăng Hỏa": "Hỏa", "Thiên Thượng Hỏa": "Hỏa",
            "Lộ Bàng Thổ": "Thổ", "Thành Đầu Thổ": "Thổ", "Ốc Thượng Thổ": "Thổ", "Bích Thượng Thổ": "Thổ", "Đại Dịch Thổ": "Thổ", "Sa Trung Thổ": "Thổ"
        };

        const hanhToColors = {
            "Hỏa": "Đỏ hoặc Vàng",
            "Thủy": "Xanh dương, Xanh lơ, hoặc Xanh da trời",
            "Mộc": "Xanh Lá Cây hoặc Xanh nước biển",
            "Thổ": "Vàng, Hồng, hoặc Đỏ",
            "Kim": "Vàng hoặc Xanh nước biển"
        };
        
        const diaChiInteractions = { "Tý": { nhiHop: "Sửu", tamHop: ["Thân", "Thìn"], xung: "Ngọ", hai: "Mùi", hinh: "Mão" }, "Sửu": { nhiHop: "Tý", tamHop: ["Tị", "Dậu"], xung: "Mùi", hai: "Ngọ", hinh: ["Tuất", "Mùi"] }, "Dần": { nhiHop: "Hợi", tamHop: ["Ngọ", "Tuất"], xung: "Thân", hai: "Tị", hinh: ["Tị", "Thân"] }, "Mão": { nhiHop: "Tuất", tamHop: ["Hợi", "Mùi"], xung: "Dậu", hai: "Thìn", hinh: "Tý" }, "Thìn": { nhiHop: "Dậu", tamHop: ["Tý", "Thân"], xung: "Tuất", hai: "Mão", hinh: "Thìn" }, "Tị": { nhiHop: "Thân", tamHop: ["Sửu", "Dậu"], xung: "Hợi", hai: "Dần", hinh: ["Dần", "Thân"] }, "Ngọ": { nhiHop: "Mùi", tamHop: ["Dần", "Tuất"], xung: "Tý", hai: "Sửu", hinh: "Ngọ" }, "Mùi": { nhiHop: "Ngọ", tamHop: ["Hợi", "Mão"], xung: "Sửu", hai: "Tý", hinh: ["Sửu", "Tuất"] }, "Thân": { nhiHop: "Tị", tamHop: ["Tý", "Thìn"], xung: "Dần", hai: "Hợi", hinh: ["Dần", "Tị"] }, "Dậu": { nhiHop: "Thìn", tamHop: ["Sửu", "Tị"], xung: "Mão", hai: "Tuất", hinh: "Dậu" }, "Tuất": { nhiHop: "Mão", tamHop: ["Dần", "Ngọ"], xung: "Thìn", hai: "Dậu", hinh: ["Sửu", "Mùi"] }, "Hợi": { nhiHop: "Dần", tamHop: ["Mão", "Mùi"], xung: "Tị", hai: "Thân", hinh: "Hợi" } };
        const nguHanhSinhKhac = { "Kim": { sinh: "Thủy", khac: "Mộc" }, "Thủy": { sinh: "Mộc", khac: "Hỏa" }, "Mộc": { sinh: "Hỏa", khac: "Thổ" }, "Hỏa": { sinh: "Thổ", khac: "Kim" }, "Thổ": { sinh: "Kim", khac: "Thủy" } };
        let fullResults = []; 

        // HELPER FUNCTIONS
        function getHoaGiapByName(name) { return hoaGiap.find(item => item.name === name); }
        function getInteractionText(hanh1, hanh2) { if (hanh1 === hanh2) return "Bình hòa"; if (nguHanhSinhKhac[hanh1]?.sinh === hanh2) return "Năm sinh Tuổi"; if (nguHanhSinhKhac[hanh2]?.sinh === hanh1) return "Tuổi sinh Năm"; if (nguHanhSinhKhac[hanh1]?.khac === hanh2) return "Năm khắc Tuổi"; if (nguHanhSinhKhac[hanh2]?.khac === hanh1) return "Tuổi khắc Năm"; return "Không tương tác"; }
        function isTamTai(ageChi, yearChi) { const sufferYearsByAgeGroup = { "Thân": ["Dần", "Mão", "Thìn"], "Tý": ["Dần", "Mão", "Thìn"], "Thìn": ["Dần", "Mão", "Thìn"], "Tị": ["Hợi", "Tý", "Sửu"], "Dậu": ["Hợi", "Tý", "Sửu"], "Sửu": ["Hợi", "Tý", "Sửu"], "Dần": ["Thân", "Dậu", "Tuất"], "Ngọ": ["Thân", "Dậu", "Tuất"], "Tuất": ["Thân", "Dậu", "Tuất"], "Hợi": ["Tị", "Ngọ", "Mùi"], "Mão": ["Tị", "Ngọ", "Mùi"], "Mùi": ["Tị", "Ngọ", "Mùi"] }; const sufferingYears = sufferYearsByAgeGroup[ageChi]; return sufferingYears ? sufferingYears.includes(yearChi) : false; }
        
        function getBirthYear(ageIndex) {
            const currentRealYear = new Date().getFullYear();
            const referenceYearName = "Giáp Tý";
            const referenceYear = 1984;
            const referenceIndex = hoaGiap.find(item => item.name === referenceYearName).index;
            const targetYear = referenceYear + (ageIndex - referenceIndex);
            
            let birthYear = targetYear;
            while(birthYear + 60 <= currentRealYear) {
                birthYear += 60;
            }
            while(birthYear > currentRealYear) {
                birthYear -= 60;
            }
            return birthYear;
        }

        // Generic Interaction Scoring Function based on new rule
        function getInteractionScoreWithAmDuong(hanh1, hanh2, sign1, sign2) {
            const relation = getInteractionText(hanh1, hanh2);
            const sameSign = sign1 === sign2;
            switch (relation) {
                case "Năm sinh Tuổi":
                    return { score: sameSign ? 10 : 7, text: `Năm sinh Tuổi (${sameSign ? 'cùng dấu - rất tốt' : 'khác dấu - tốt'})` };
                case "Bình hòa":
                    return { score: 5, text: "Bình hòa" };
                case "Tuổi sinh Năm":
                    return { score: 2, text: "Tuổi sinh Năm (hao tổn)" };
                case "Năm khắc Tuổi":
                    return { score: sameSign ? 0 : 1, text: `Năm khắc Tuổi (${sameSign ? 'cùng dấu - rất xấu' : 'khác dấu - xấu'})` };
                case "Tuổi khắc Năm":
                    return { score: 0, text: "Tuổi khắc Năm (phạm thượng)" };
                default:
                    return { score: 0, text: "Không tương tác" };
            }
        }
        
        // MAIN CALCULATION FUNCTION
        function runFullCalculation() {
            if (fullResults.length > 0) return; // Only calculate once per year change
            const selectedYearName = document.getElementById('yearSelect').value;
            const yearData = getHoaGiapByName(selectedYearName);
            if (!yearData) { console.error("Year data not found for:", selectedYearName); return; }
            const yearHanhNguHanh = menhToHanh[yearData.menh];
            if (!yearHanhNguHanh) { console.error("Hanh not found for Menh:", yearData.menh); return; }
            const yearCanSign = canAmDuong[yearData.can];
            let allScores = [];

            for (const ageData of hoaGiap) {
                let breakdown = [];
                let isPham = false;

                // 1. Thiên Can Score (50%)
                const ageCanSign = canAmDuong[ageData.can];
                // 1a. Tiên Thiên (60% -> 30 points max)
                const yearTienThienHanh = tienThienCanHanh[yearData.can];
                const ageTienThienHanh = tienThienCanHanh[ageData.can];
                const tienThienResult = getInteractionScoreWithAmDuong(yearTienThienHanh, ageTienThienHanh, yearCanSign, ageCanSign);
                const tienThienScore = tienThienResult.score * 3.0;
                breakdown.push(`Can Tiên thiên: ${tienThienResult.text} (+${tienThienScore.toFixed(1)}đ)`);
                
                // 1b. Hậu Thiên (40% -> 20 points max)
                let hauThienScore = 0;
                if (hauThienHopPairs[yearData.can] === ageData.can) {
                    hauThienScore = 10 * 2.0; 
                    breakdown.push(`Can Hậu thiên: Hợp hóa (Tốt nhất) (+20.0đ)`);
                } else {
                    const yearHauThienHanh = hauThienCanHanh[yearData.can];
                    const ageHauThienHanh = hauThienCanHanh[ageData.can];
                    const hauThienResult = getInteractionScoreWithAmDuong(yearHauThienHanh, ageHauThienHanh, yearCanSign, ageCanSign);
                    hauThienScore = hauThienResult.score * 2.0;
                    breakdown.push(`Can Hậu thiên: ${hauThienResult.text} (+${hauThienScore.toFixed(1)}đ)`);
                }
                let canScore = tienThienScore + hauThienScore;
                
                // 2. Mệnh Score (30%)
                const ageHanhNguHanh = menhToHanh[ageData.menh];
                const menhResult = getInteractionScoreWithAmDuong(yearHanhNguHanh, ageHanhNguHanh, yearCanSign, ageCanSign);
                const menhScore = menhResult.score * 3.0;
                breakdown.push(`Ngũ hành Mệnh: ${menhResult.text} (+${menhScore.toFixed(1)}đ)`);

                // 3. Địa Chi Score (20%)
                let chiScore = 0;
                let chiDetail = "";
                const yearChiInteractions = diaChiInteractions[yearData.chi];
                if (yearChiInteractions.tamHop.includes(ageData.chi)) {
                    chiScore = 20;
                    chiDetail = "Địa chi: Tam hợp (Rất tốt)";
                } else if (yearChiInteractions.nhiHop === ageData.chi) {
                    chiScore = 16;
                    chiDetail = "Địa chi: Nhị hợp (Tốt)";
                } else if (yearChiInteractions.xung === ageData.chi) {
                    chiScore = 0;
                    chiDetail = "Địa chi: Tương Xung (Rất xấu)";
                } else if (ageData.chi === yearData.chi || (Array.isArray(yearChiInteractions.hinh) ? yearChiInteractions.hinh.includes(ageData.chi) : yearChiInteractions.hinh === ageData.chi)) {
                    chiScore = 0;
                    chiDetail = "Địa chi: Tương Hình (Rất xấu)";
                } else if (yearChiInteractions.hai === ageData.chi) {
                    chiScore = 2;
                    chiDetail = "Địa chi: Tương Hại (Xấu)";
                } else {
                    chiScore = 10;
                    chiDetail = "Địa chi: Bình hòa (Trung bình)";
                }
                breakdown.push(`${chiDetail} (+${chiScore.toFixed(1)}đ)`);

                let totalScore = canScore + menhScore + chiScore;
                
                // Penalties
                if (isTamTai(ageData.chi, yearData.chi)) { totalScore *= 0.7; breakdown.push(`<span class="penalty">Phạm Tam Tai (-30%)</span>`); isPham = true; }
                if (ageData.chi === yearData.chi) { 
                    totalScore *= 0.85; 
                    breakdown.push(`<span class="penalty">Phạm Thái Tuế (-15%)</span>`); 
                    isPham = true; 
                }
                else if (diaChiInteractions[yearData.chi].xung === ageData.chi) { 
                    totalScore *= 0.85; 
                    breakdown.push(`<span class="penalty">Phạm Xung Thái Tuế (-15%)</span>`); 
                    isPham = true; 
                }
                
                allScores.push({ ...ageData, totalScore: totalScore, isPham: isPham, breakdown: `<ul><li>${breakdown.join('</li><li>')}</li></ul>` });
            }
            allScores.sort((a, b) => b.totalScore - a.totalScore);
            fullResults = allScores;
        }
        
        // DISPLAY AND UI FUNCTIONS
        function displayGoodList() {
            if (fullResults.length === 0) runFullCalculation();
            const selectedYearName = document.getElementById('yearSelect').value;
            const eligibleScores = fullResults.filter(item => !item.isPham);
            const top10 = eligibleScores.slice(0, 10);
            document.getElementById('resultsHeader').innerText = `Top 10 Tuổi Tốt Nhất Năm ${selectedYearName}`;
            document.getElementById('exportGoodButton').style.display = 'inline-block';
            document.getElementById('exportBadButton').style.display = 'none';
            renderTable(top10);
        }

        function displayBadList() {
            if (fullResults.length === 0) runFullCalculation();
            const selectedYearName = document.getElementById('yearSelect').value;
            const bottom10 = fullResults.slice(-10).reverse();
            document.getElementById('resultsHeader').innerText = `10 Tuổi Xấu Nhất Năm ${selectedYearName}`;
            document.getElementById('exportGoodButton').style.display = 'none';
            document.getElementById('exportBadButton').style.display = 'inline-block';
            renderTable(bottom10);
        }

        function displayAllList() {
            if (fullResults.length === 0) runFullCalculation();
            const selectedYearName = document.getElementById('yearSelect').value;
            document.getElementById('resultsHeader').innerText = `Bảng Xếp Hạng 60 Hoa Giáp Năm ${selectedYearName}`;
            document.getElementById('exportGoodButton').style.display = 'none';
            document.getElementById('exportBadButton').style.display = 'none';
            renderTable(fullResults);
        }

        function renderTable(data) {
            const resultsBody = document.getElementById('resultsBody');
            resultsBody.innerHTML = '';
            if (data.length === 0) { resultsBody.innerHTML = `<tr><td colspan="5" style="text-align:center;">Không tìm thấy kết quả phù hợp.</td></tr>`; }
            else { data.forEach((item, index) => { const row = `<tr><td class="rank">${index + 1}</td><td>${item.name}</td><td>${item.menh}</td><td class="score">${item.totalScore.toFixed(2)}</td><td class="details">${item.breakdown}</td></tr>`; resultsBody.innerHTML += row; }); }
        }

        function handleGoodExport() {
            const eligibleScores = fullResults.filter(item => !item.isPham);
            const top10 = eligibleScores.slice(0, 10);
            if (top10.length === 0) { alert("Chưa có kết quả tuổi tốt để xuất."); return; }
            const selectedYearName = document.getElementById('yearSelect').value;
            const yearData = getHoaGiapByName(selectedYearName);
            const yearHanh = menhToHanh[yearData.menh];
            const recommendedColors = hanhToColors[yearHanh] || "phù hợp";
            const yearBirthYear = getBirthYear(yearData.index);

            let exportString = `*TUỔI XÔNG ĐẤT VÀ MỞ HÀNG KHAI TRƯƠNG CHO NĂM ${selectedYearName.toUpperCase()} (${yearBirthYear}) VẬN KHÍ ${yearData.menh.toUpperCase()}*\n\n`;
            exportString += "Danh sách 10 tuổi tốt nhất:\n\n";
            top10.forEach((item, index) => { const namSinh = getBirthYear(item.index); exportString += `${index + 1}. ${item.name} (${namSinh})\n`; });
            exportString += "\nLưu ý:\n";
            exportString += "- Những tuổi như trên được mời mua mở hàng khai trương đầu năm, động thổ xây sửa nhà, dự lễ về nhà mới, đi đón cô dâu về nhà chồng, tiễn đưa người thân đi làm ăn xa, đón em bé từ bảo sanh viện về nhà, dự lễ cúng đầy tháng, dự lễ cúng thôi nôi cho em bé, dự lễ cúng đáo tuế, cúng thất tuần cho gia chủ sẽ được cát tường đại lợi.\n\n";
            exportString += "- Họ phải không trong thời gian thọ tang. Nam nữ đều tốt, không bị xui xẻo, nạn tai, chọn người tử tế đàng hoàng, nhân cách đầy đủ, trí tuệ thông minh, hiền hậu nhân từ. Phúc lộc đầy đủ.\n\n";
            exportString += "- Người được mời xông đất, khai trương đâù năm kiêng mặc áo trắng hoặc đen.\n\n";
            exportString += `- Người xông đất hoặc mua hàng khai trương cho gia chủ phải mặc áo tông màu ${recommendedColors} là thuận nhất với năm ${selectedYearName} vận khí ${yearData.menh}.`;
            
            document.getElementById('modalHeader').innerText = "Kết Quả Tuổi Tốt";
            document.getElementById('exportTextarea').value = exportString;
            document.getElementById('exportModal').style.display = "block";
        }

        function handleBadExport() {
            const bottom10 = fullResults.slice(-10).reverse();
            if (bottom10.length === 0) { alert("Chưa có kết quả tuổi xấu để xuất."); return; }
            const selectedYearName = document.getElementById('yearSelect').value;
            const yearData = getHoaGiapByName(selectedYearName);
            const yearBirthYear = getBirthYear(yearData.index);
            let exportString = `*DANH SÁCH 10 TUỔI XẤU NHẤT TRONG NĂM ${selectedYearName.toUpperCase()} (${yearBirthYear}) VẬN KHÍ ${yearData.menh.toUpperCase()}*\n\n`;
            exportString += "Danh sách 10 tuổi xấu nhất:\n\n";
            bottom10.forEach((item, index) => { const namSinh = getBirthYear(item.index); exportString += `${index + 1}. ${item.name} (${namSinh})\n`; });
            exportString += "\nLưu ý:\n";
            exportString += "- Những tuổi có trong danh sách trên được xem là không thuận lợi để tiến hành các công việc trọng đại trong năm như xông đất, mở hàng khai trương, động thổ, cưới hỏi, nhập trạch... Gia chủ nên cân nhắc kỹ lưỡng khi hợp tác hoặc để những tuổi này thực hiện các công việc quan trọng, nhằm tránh gặp phải những điều không may mắn, trở ngại hoặc kết quả không như ý.";
            document.getElementById('modalHeader').innerText = "Kết Quả Tuổi Xấu";
            document.getElementById('exportTextarea').value = exportString;
            document.getElementById('exportModal').style.display = "block";
        }
        
        function openTab(evt, tabName) {
            let i, tabcontent, tablinks;
            tabcontent = document.getElementsByClassName("tab-content");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }
            tablinks = document.getElementsByClassName("tab-link");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(" active", "");
            }
            document.getElementById(tabName).style.display = "block";
            evt.currentTarget.className += " active";
        }

        function init() {
            const yearSelect = document.getElementById('yearSelect');
            hoaGiap.forEach(item => { const option = document.createElement('option'); option.value = item.name; option.textContent = item.name; yearSelect.appendChild(option); });
            yearSelect.value = "Bính Tý"; 
            
            // Event Listeners
            document.getElementById('viewGoodButton').addEventListener('click', displayGoodList);
            document.getElementById('viewBadButton').addEventListener('click', displayBadList);
            document.getElementById('viewAllButton').addEventListener('click', displayAllList);
            document.getElementById('exportGoodButton').addEventListener('click', handleGoodExport);
            document.getElementById('exportBadButton').addEventListener('click', handleBadExport);
            
            yearSelect.addEventListener('change', () => {
                fullResults = []; // Clear cache on year change
                const activeTab = document.querySelector('.button-group .active-view'); // Check which view is active
                if (document.getElementById('resultsHeader').innerText.includes("10 Tuổi Xấu Nhất")) {
                    displayBadList();
                } else if (document.getElementById('resultsHeader').innerText.includes("60 Hoa Giáp")) {
                    displayAllList();
                } else {
                    displayGoodList();
                }
            });

            // Modal listeners
            const modal = document.getElementById('exportModal');
            const closeBtn = document.querySelector('.close-button');
            closeBtn.onclick = () => { modal.style.display = "none"; };
            window.onclick = (event) => { if (event.target == modal) { modal.style.display = "none"; } };
            
            // Default view
            document.querySelector('.tab-link').click(); // Open the first tab by default
            displayGoodList();
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
