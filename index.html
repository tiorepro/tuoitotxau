<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>C√¥ng c·ª• Ch·ªçn Tu·ªïi X√¥ng ƒê·∫•t (Ho√†n Ch·ªânh)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; line-height: 1.6; margin: 0; padding: 20px; background-color: #f4f4f4; color: #333; }
        .container { max-width: 1200px; margin: auto; background: #fff; padding: 25px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1, h2 { text-align: center; color: #2c3e50; }
        h3 { color: #34495e; margin-top: 30px; border-bottom: 2px solid #3498db; padding-bottom: 10px; }

        .tab-nav { overflow: hidden; border-bottom: 2px solid #ccc; margin-bottom: 20px; }
        .tab-nav button { background-color: inherit; float: left; border: none; outline: none; cursor: pointer; padding: 14px 16px; transition: 0.3s; font-size: 1.1em; font-weight: bold; color: #34495e; }
        .tab-nav button:hover { background-color: #f1f1f1; }
        .tab-nav button.active { background-color: #3498db; color: white; border-radius: 5px 5px 0 0; }
        .tab-nav button.active.tab-red { background-color: #e74c3c; }
        
        .tab-content { display: none; animation: fadeEffect 0.5s; }
        @keyframes fadeEffect { from {opacity: 0;} to {opacity: 1;} }

        .input-section { display: flex; flex-direction: column; align-items: center; gap: 15px; margin-bottom: 30px; }
        .button-group { display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; }
        label { font-weight: bold; font-size: 1.1em; }
        select, button { padding: 12px 18px; border-radius: 5px; border: 1px solid #ccc; font-size: 1em; cursor: pointer; transition: background-color 0.2s ease; }
        button.action-btn { background-color: #3498db; color: white; border: none; }
        button.action-btn:hover { background-color: #2980b9; }
        button.action-btn.bad { background-color: #c0392b; }
        button.action-btn.bad:hover { background-color: #a93226; }
        button.action-btn.all { background-color: #7f8c8d; }
        button.action-btn.all:hover { background-color: #626f70; }
        button.action-btn.export { background-color: #27ae60; }
        button.action-btn.export:hover { background-color: #229954; }
        button.export-btn { margin-top: 15px; display: none; }
        button#exportGoodButton { background-color: #27ae60; color: white; border: none; }
        button#exportGoodButton:hover { background-color: #229954; }
        button#exportBadButton { background-color: #e74c3c; color: white; border: none; }
        button#exportBadButton:hover { background-color: #c0392b; }

        .results-header-container { text-align: center; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 12px; border: 1px solid #ddd; text-align: left; vertical-align: top; }
        th { background-color: #ecf0f1; font-weight: bold; }
        .rank { font-weight: bold; text-align: center; }
        .score { font-weight: bold; color: #e74c3c; text-align: center; }
        .details ul { padding-left: 20px; margin: 0; font-size: 0.9em; }
        .details li { margin-bottom: 4px; }
        .penalty { color: #c0392b; font-style: italic; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color: #fefefe; margin: 5% auto; padding: 20px; border: 1px solid #888; width: 90%; max-width: 700px; border-radius: 8px; }
        .close-button { color: #aaa; float: right; font-size: 28px; font-weight: bold; }
        .close-button:hover, .close-button:focus { color: black; text-decoration: none; cursor: pointer; }
        #exportTextarea { width: 100%; height: 450px; margin-top: 15px; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; font-size: 15px; line-height: 1.6; white-space: pre-wrap; word-wrap: break-word; box-sizing: border-box; border: 1px solid #ccc; padding: 10px; }

        /* Dashboard Styles */
        .dashboard-controls { 
            display: flex; 
            flex-wrap: wrap; 
            gap: 20px; 
            justify-content: center; 
            align-items: center; 
            padding: 20px; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            border-radius: 10px; 
            margin-bottom: 25px; 
        }
        .control-group { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            gap: 8px; 
        }
        .control-group label { 
            color: white; 
            font-size: 0.95em; 
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3); 
        }
        .control-group select { 
            min-width: 180px; 
            padding: 10px 15px; 
            border: none; 
            border-radius: 8px; 
            font-size: 1em; 
            background: white; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.15); 
        }
        .control-buttons {
            display: flex;
            gap: 10px;
            margin-top: 24px;
        }
        .dashboard-title { 
            text-align: center; 
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); 
            -webkit-background-clip: text; 
            -webkit-text-fill-color: transparent; 
            background-clip: text; 
            font-size: 1.4em; 
            margin-bottom: 25px; 
            padding: 15px; 
            border: 2px solid #3498db; 
            border-radius: 10px; 
        }
        .chart-container { 
            position: relative; 
            margin: 20px auto; 
            padding: 20px; 
            background: #fff; 
            border-radius: 12px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); 
        }
        .chart-section-title { 
            text-align: center; 
            color: #2c3e50; 
            font-size: 1.2em; 
            margin-bottom: 15px; 
            padding: 10px; 
            background: #ecf0f1; 
            border-radius: 8px; 
        }
        .year-chart-container { 
            height: 400px; 
        }
        .month-chart-container { 
            height: 350px; 
        }
        .day-chart-container { 
            height: 300px; 
        }
        .legend-container { 
            display: flex; 
            justify-content: center; 
            flex-wrap: wrap; 
            gap: 15px; 
            margin: 15px 0; 
            padding: 10px; 
            background: #f8f9fa; 
            border-radius: 8px; 
        }
        .legend-item { 
            display: flex; 
            align-items: center; 
            gap: 6px; 
            font-size: 0.85em; 
        }
        .legend-color { 
            width: 20px; 
            height: 20px; 
            border-radius: 4px; 
        }
        
        .summary-cards { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); 
            gap: 20px; 
            margin-bottom: 25px; 
        }
        .summary-card { 
            padding: 25px; 
            border-radius: 12px; 
            text-align: center; 
            color: white; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.2); 
        }
        .summary-card.tuoi { background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); }
        .summary-card.nam { background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); }
        .summary-card h4 { margin: 0 0 10px 0; font-size: 1em; opacity: 0.9; }
        .summary-card .value { font-size: 1.6em; font-weight: bold; margin-bottom: 8px; }
        .summary-card .sub-info { font-size: 1em; opacity: 0.95; }
        
        .month-selector { 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            gap: 15px; 
            margin-bottom: 15px; 
        }
        .month-selector select { 
            padding: 8px 15px; 
            border-radius: 6px; 
            border: 2px solid #3498db; 
            font-size: 1em; 
        }

        /* Print Report Styles */
        .print-report-modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.7);
        }
        .print-report-content {
            background-color: white;
            margin: 20px auto;
            padding: 0;
            width: 297mm;
            box-shadow: 0 0 20px rgba(0,0,0,0.3);
        }
        .print-controls {
            position: fixed;
            top: 10px;
            right: 30px;
            z-index: 2001;
            display: flex;
            gap: 10px;
        }
        .print-controls button {
            padding: 12px 24px;
            font-size: 1em;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
        }
        .print-controls .print-btn {
            background: #27ae60;
            color: white;
        }
        .print-controls .close-print-btn {
            background: #e74c3c;
            color: white;
        }

        /* A4 Landscape Report Layout */
        .report-page {
            width: 297mm;
            height: 210mm;
            padding: 8mm 10mm;
            background: white;
            box-sizing: border-box;
            page-break-after: always;
            position: relative;
            display: flex;
            flex-direction: column;
        }
        .report-page:last-child {
            page-break-after: avoid;
        }
        .report-header {
            text-align: center;
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 3px solid #3498db;
            flex-shrink: 0;
        }
        .report-header h1 {
            font-size: 1.3em;
            color: #2c3e50;
            margin: 0 0 5px 0;
        }
        .report-header .subtitle {
            font-size: 0.95em;
            color: #7f8c8d;
        }
        
        .report-charts-row {
            display: flex;
            gap: 12px;
            flex: 1;
        }
        .report-chart-half {
            flex: 1;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 8px;
            display: flex;
            flex-direction: column;
        }
        .report-chart-full {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 8px;
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        .report-chart-title {
            text-align: center;
            font-size: 0.9em;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
            padding: 5px;
            background: #ecf0f1;
            border-radius: 5px;
            flex-shrink: 0;
        }
        .report-legend {
            display: flex;
            justify-content: center;
            gap: 15px;
            font-size: 0.7em;
            margin-bottom: 5px;
            flex-shrink: 0;
        }
        .report-legend-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .report-legend-color {
            width: 12px;
            height: 12px;
            border-radius: 3px;
        }
        .report-chart-container {
            flex: 1;
            min-height: 0;
        }
        .report-chart-container-year {
            flex: 1;
            min-height: 0;
        }
        .report-chart-container-month {
            flex: 1;
            min-height: 0;
        }
        .report-chart-container-day {
            flex: 1;
            min-height: 0;
        }
        .report-footer {
            text-align: center;
            font-size: 0.75em;
            color: #7f8c8d;
            padding-top: 5px;
            border-top: 1px solid #ddd;
            flex-shrink: 0;
            margin-top: auto;
        }

        /* Page 2+ styles */
        .report-page-secondary {
            width: 297mm;
            height: 210mm;
            padding: 8mm 10mm;
            background: white;
            box-sizing: border-box;
            page-break-after: always;
            position: relative;
            display: flex;
            flex-direction: column;
        }
        .report-page-secondary:last-child {
            page-break-after: avoid;
        }
        .report-page-header {
            text-align: center;
            font-size: 0.85em;
            color: #7f8c8d;
            margin-bottom: 8px;
            padding-bottom: 5px;
            border-bottom: 1px solid #ddd;
            flex-shrink: 0;
        }
        .report-day-charts-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
            flex: 1;
        }
        .report-day-chart-wrapper {
            flex: 1;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 8px;
            display: flex;
            flex-direction: column;
        }
        .report-day-chart-inner {
            flex: 1;
            min-height: 0;
        }

        @media print {
            body * {
                visibility: hidden;
            }
            .print-report-modal, .print-report-modal * {
                visibility: visible;
            }
            .print-report-modal {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                height: auto;
                background: white;
                overflow: visible;
            }
            .print-report-content {
                margin: 0;
                box-shadow: none;
                width: 100%;
            }
            .print-controls {
                display: none;
            }
            .report-page, .report-page-secondary {
                page-break-after: always;
                height: 210mm;
            }
            .report-page:last-child, .report-page-secondary:last-child {
                page-break-after: avoid;
            }
            @page {
                size: A4 landscape;
                margin: 0;
            }
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>C√¥ng c·ª• Phong Th·ªßy</h1>

        <div class="tab-nav">
            <button class="tab-link" onclick="openTab(event, 'tabTuoiTotXau')">TU·ªîI T·ªêT/X·∫§U TRONG NƒÇM</button>
            <button class="tab-link tab-red" onclick="openTab(event, 'tabDinhLuong')">ƒê·ªäNH L∆Ø·ª¢NG T∆Ø∆†NG T√ÅC</button>
        </div>

        <!-- Tab 1: Tu·ªïi T·ªët/X·∫•u -->
        <div id="tabTuoiTotXau" class="tab-content">
            <div class="input-section">
                <label for="yearSelect">Ch·ªçn nƒÉm c·∫ßn xem:</label>
                <select id="yearSelect"></select>
                <div class="button-group">
                    <button id="viewGoodButton" class="action-btn">Xem 10 Tu·ªïi T·ªët Nh·∫•t</button>
                    <button id="viewBadButton" class="action-btn bad">Xem 10 Tu·ªïi X·∫•u Nh·∫•t</button>
                    <button id="viewAllButton" class="action-btn all">Xem B·∫£ng 60 Hoa Gi√°p</button>
                </div>
            </div>
            <div class="results-header-container">
                <h2 id="resultsHeader"></h2>
                <button id="exportGoodButton" class="export-btn">Xu·∫•t K·∫øt Qu·∫£ T·ªët</button>
                <button id="exportBadButton" class="export-btn bad">Xu·∫•t Danh S√°ch X·∫•u</button>
            </div>
            <div style="overflow-x:auto;">
                <table>
                    <thead>
                        <tr>
                            <th>H·∫°ng</th>
                            <th>Tu·ªïi</th>
                            <th>M·ªánh</th>
                            <th>ƒêi·ªÉm</th>
                            <th>Chi Ti·∫øt</th>
                        </tr>
                    </thead>
                    <tbody id="resultsBody"></tbody>
                </table>
            </div>
        </div>

        <!-- Tab 2: ƒê·ªãnh L∆∞·ª£ng T∆∞∆°ng T√°c -->
        <div id="tabDinhLuong" class="tab-content">
            <div class="dashboard-controls">
                <div class="control-group">
                    <label for="dlYearSelect">üìÖ NƒÉm Xem</label>
                    <select id="dlYearSelect"></select>
                </div>
                <div class="control-group">
                    <label for="dlTuoiSelect">üéÇ Tu·ªïi Xem</label>
                    <select id="dlTuoiSelect"></select>
                </div>
                <div class="control-group">
                    <label for="dlGenderSelect">‚ö§ Gi·ªõi T√≠nh</label>
                    <select id="dlGenderSelect">
                        <option value="nam">Nam</option>
                        <option value="nu">N·ªØ</option>
                    </select>
                </div>
                <div class="control-group">
                    <div class="control-buttons">
                        <button class="action-btn" onclick="generateDashboard()">üîç Xem T∆∞∆°ng T√°c</button>
                        <button class="action-btn export" onclick="openPrintReport()">üìÑ Xu·∫•t K·∫øt Qu·∫£</button>
                    </div>
                </div>
            </div>

            <div id="dashboardTitle" class="dashboard-title" style="display: none;"></div>
            <div id="summaryCards" class="summary-cards" style="display: none;"></div>

            <div id="yearChartSection" class="chart-container" style="display: none;">
                <div class="chart-section-title">üìä T∆Ø∆†NG T√ÅC 7 NƒÇM (3 nƒÉm tr∆∞·ªõc - Hi·ªán t·∫°i - 3 nƒÉm sau)</div>
                <div class="legend-container">
                    <div class="legend-item"><span class="legend-color" style="background: #e74c3c;"></span> Tam Tai</div>
                    <div class="legend-item"><span class="legend-color" style="background: #1e8449;"></span> Th√°i Tu·∫ø</div>
                    <div class="legend-item"><span class="legend-color" style="background: #e67e22;"></span> Xung Th√°i Tu·∫ø</div>
                </div>
                <div class="year-chart-container">
                    <canvas id="yearChart"></canvas>
                </div>
            </div>

            <div id="monthChartSection" class="chart-container" style="display: none;">
                <div class="chart-section-title">üìà T∆Ø∆†NG T√ÅC 12 TH√ÅNG √ÇM L·ªäCH TRONG NƒÇM</div>
                <div class="month-chart-container">
                    <canvas id="monthChart"></canvas>
                </div>
            </div>

            <div id="dayChartSection" class="chart-container" style="display: none;">
                <div class="chart-section-title">üìÖ T∆Ø∆†NG T√ÅC C√ÅC NG√ÄY TRONG TH√ÅNG √ÇM L·ªäCH</div>
                <div class="month-selector">
                    <label for="dayMonthSelect"><strong>Ch·ªçn th√°ng √¢m l·ªãch:</strong></label>
                    <select id="dayMonthSelect" onchange="updateDayChart()"></select>
                </div>
                <div class="day-chart-container">
                    <canvas id="dayChart"></canvas>
                </div>
            </div>
        </div>
        
    </div>

    <!-- Modal Tab 1 -->
    <div id="exportModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2 id="modalHeader"></h2>
            <textarea id="exportTextarea" readonly></textarea>
        </div>
    </div>

    <!-- Print Report Modal -->
    <div id="printReportModal" class="print-report-modal">
        <div class="print-controls">
            <button class="print-btn" onclick="printReport()">üñ®Ô∏è In / L∆∞u PDF</button>
            <button class="close-print-btn" onclick="closePrintReport()">‚úï ƒê√≥ng</button>
        </div>
        <div class="print-report-content" id="printReportContent">
            <!-- Content will be generated dynamically -->
        </div>
    </div>

    <script>
        // ==================== LUNAR CALENDAR FUNCTIONS ====================
        const PI = Math.PI;
        const CAN = ["Gi√°p", "·∫§t", "B√≠nh", "ƒêinh", "M·∫≠u", "K·ª∑", "Canh", "T√¢n", "Nh√¢m", "Qu√Ω"];
        const CHI = ["T√Ω", "S·ª≠u", "D·∫ßn", "M√£o", "Th√¨n", "T·ªµ", "Ng·ªç", "M√πi", "Th√¢n", "D·∫≠u", "Tu·∫•t", "H·ª£i"];
        const THANG_DIA_CHI = ["D·∫ßn", "M√£o", "Th√¨n", "T·ªµ", "Ng·ªç", "M√πi", "Th√¢n", "D·∫≠u", "Tu·∫•t", "H·ª£i", "T√Ω", "S·ª≠u"];

        function INT(d) { return Math.floor(d); }

        function jdFromDate(dd, mm, yy) {
            var a, y, m, jd;
            a = INT((14 - mm) / 12);
            y = yy + 4800 - a;
            m = mm + 12*a - 3;
            jd = dd + INT((153*m+2)/5) + 365*y + INT(y/4) - INT(y/100) + INT(y/400) - 32045;
            if (jd < 2299161) {
                jd = dd + INT((153*m+2)/5) + 365*y + INT(y/4) - 32083;
            }
            return jd;
        }

        function jdToDate(jd) {
            var a, b, c, d, e, m, day, month, year;
            if (jd > 2299160) {
                a = jd + 32044;
                b = INT((4*a+3)/146097);
                c = a - INT((b*146097)/4);
            } else {
                b = 0;
                c = jd + 32082;
            }
            d = INT((4*c+3)/1461);
            e = c - INT((1461*d)/4);
            m = INT((5*e+2)/153);
            day = e - INT((153*m+2)/5) + 1;
            month = m + 3 - 12*INT(m/10);
            year = b*100 + d - 4800 + INT(m/10);
            return [day, month, year];
        }

        function getNewMoonDay(k, timeZone) {
            var T, T2, T3, dr, Jd1, M, Mpr, F, C1, deltat, JdNew;
            T = k/1236.85;
            T2 = T * T;
            T3 = T2 * T;
            dr = PI/180;
            Jd1 = 2415020.75933 + 29.53058868*k + 0.0001178*T2 - 0.000000155*T3;
            Jd1 = Jd1 + 0.00033*Math.sin((166.56 + 132.87*T - 0.009173*T2)*dr);
            M = 359.2242 + 29.10535608*k - 0.0000333*T2 - 0.00000347*T3;
            Mpr = 306.0253 + 385.81691806*k + 0.0107306*T2 + 0.00001236*T3;
            F = 21.2964 + 390.67050646*k - 0.0016528*T2 - 0.00000239*T3;
            C1=(0.1734 - 0.000393*T)*Math.sin(M*dr) + 0.0021*Math.sin(2*dr*M);
            C1 = C1 - 0.4068*Math.sin(Mpr*dr) + 0.0161*Math.sin(dr*2*Mpr);
            C1 = C1 - 0.0004*Math.sin(dr*3*Mpr);
            C1 = C1 + 0.0104*Math.sin(dr*2*F) - 0.0051*Math.sin(dr*(M+Mpr));
            C1 = C1 - 0.0074*Math.sin(dr*(M-Mpr)) + 0.0004*Math.sin(dr*(2*F+M));
            C1 = C1 - 0.0004*Math.sin(dr*(2*F-M)) - 0.0006*Math.sin(dr*(2*F+Mpr));
            C1 = C1 + 0.0010*Math.sin(dr*(2*F-Mpr)) + 0.0005*Math.sin(dr*(2*Mpr+M));
            if (T < -11) {
                deltat = 0.001 + 0.000839*T + 0.0002261*T2 - 0.00000845*T3 - 0.000000081*T*T3;
            } else {
                deltat = -0.000278 + 0.000265*T + 0.000262*T2;
            }
            JdNew = Jd1 + C1 - deltat;
            return INT(JdNew + 0.5 + timeZone/24);
        }

        function getSunLongitude(jdn, timeZone) {
            var T, T2, dr, M, L0, DL, L;
            T = (jdn - 2451545.5 - timeZone/24) / 36525;
            T2 = T*T;
            dr = PI/180;
            M = 357.52910 + 35999.05030*T - 0.0001559*T2 - 0.00000048*T*T2;
            L0 = 280.46645 + 36000.76983*T + 0.0003032*T2;
            DL = (1.914600 - 0.004817*T - 0.000014*T2)*Math.sin(dr*M);
            DL = DL + (0.019993 - 0.000101*T)*Math.sin(dr*2*M) + 0.000290*Math.sin(dr*3*M);
            L = L0 + DL;
            L = L*dr;
            L = L - PI*2*(INT(L/(PI*2)));
            return INT(L / PI * 6);
        }

        function getLunarMonth11(yy, timeZone) {
            var k, off, nm, sunLong;
            off = jdFromDate(31, 12, yy) - 2415021;
            k = INT(off / 29.530588853);
            nm = getNewMoonDay(k, timeZone);
            sunLong = getSunLongitude(nm, timeZone);
            if (sunLong >= 9) {
                nm = getNewMoonDay(k-1, timeZone);
            }
            return nm;
        }

        function getLeapMonthOffset(a11, timeZone) {
            var k, last, arc, i;
            k = INT((a11 - 2415021.076998695) / 29.530588853 + 0.5);
            last = 0;
            i = 1;
            arc = getSunLongitude(getNewMoonDay(k+i, timeZone), timeZone);
            do {
                last = arc;
                i++;
                arc = getSunLongitude(getNewMoonDay(k+i, timeZone), timeZone);
            } while (arc != last && i < 14);
            return i-1;
        }

        function convertSolar2Lunar(dd, mm, yy, timeZone) {
            var k, dayNumber, monthStart, a11, b11, lunarDay, lunarMonth, lunarYear, lunarLeap, diff, leapMonthDiff;
            dayNumber = jdFromDate(dd, mm, yy);
            k = INT((dayNumber - 2415021.076998695) / 29.530588853);
            monthStart = getNewMoonDay(k+1, timeZone);
            if (monthStart > dayNumber) {
                monthStart = getNewMoonDay(k, timeZone);
            }
            a11 = getLunarMonth11(yy, timeZone);
            b11 = a11;
            if (a11 >= monthStart) {
                lunarYear = yy;
                a11 = getLunarMonth11(yy-1, timeZone);
            } else {
                lunarYear = yy+1;
                b11 = getLunarMonth11(yy+1, timeZone);
            }
            lunarDay = dayNumber-monthStart+1;
            diff = INT((monthStart - a11)/29);
            lunarLeap = 0;
            lunarMonth = diff+11;
            if (b11 - a11 > 365) {
                leapMonthDiff = getLeapMonthOffset(a11, timeZone);
                if (diff >= leapMonthDiff) {
                    lunarMonth = diff + 10;
                    if (diff == leapMonthDiff) {
                        lunarLeap = 1;
                    }
                }
            }
            if (lunarMonth > 12) {
                lunarMonth = lunarMonth - 12;
            }
            if (lunarMonth >= 11 && diff < 4) {
                lunarYear -= 1;
            }
            return [lunarDay, lunarMonth, lunarYear, lunarLeap];
        }

        function convertLunar2Solar(lunarDay, lunarMonth, lunarYear, lunarLeap, timeZone) {
            var k, a11, b11, off, leapOff, leapMonth, monthStart;
            if (lunarMonth < 11) {
                a11 = getLunarMonth11(lunarYear-1, timeZone);
                b11 = getLunarMonth11(lunarYear, timeZone);
            } else {
                a11 = getLunarMonth11(lunarYear, timeZone);
                b11 = getLunarMonth11(lunarYear+1, timeZone);
            }
            k = INT(0.5 + (a11 - 2415021.076998695) / 29.530588853);
            off = lunarMonth - 11;
            if (off < 0) {
                off += 12;
            }
            if (b11 - a11 > 365) {
                leapOff = getLeapMonthOffset(a11, timeZone);
                leapMonth = leapOff - 2;
                if (leapMonth < 0) {
                    leapMonth += 12;
                }
                if (lunarLeap != 0 && lunarMonth != leapMonth) {
                    return [0, 0, 0];
                } else if (lunarLeap != 0 || off >= leapOff) {
                    off += 1;
                }
            }
            monthStart = getNewMoonDay(k+off, timeZone);
            return jdToDate(monthStart + lunarDay - 1);
        }

        function getLunarMonthDays(lunarMonth, lunarYear, timeZone) {
            var a11, b11, k, off, leapOff, leapMonth, monthStart, nextMonthStart;
            
            if (lunarMonth < 11) {
                a11 = getLunarMonth11(lunarYear-1, timeZone);
                b11 = getLunarMonth11(lunarYear, timeZone);
            } else {
                a11 = getLunarMonth11(lunarYear, timeZone);
                b11 = getLunarMonth11(lunarYear+1, timeZone);
            }
            
            k = INT(0.5 + (a11 - 2415021.076998695) / 29.530588853);
            off = lunarMonth - 11;
            if (off < 0) {
                off += 12;
            }
            
            if (b11 - a11 > 365) {
                leapOff = getLeapMonthOffset(a11, timeZone);
                leapMonth = leapOff - 2;
                if (leapMonth < 0) {
                    leapMonth += 12;
                }
                if (off >= leapOff) {
                    off += 1;
                }
            }
            
            monthStart = getNewMoonDay(k + off, timeZone);
            nextMonthStart = getNewMoonDay(k + off + 1, timeZone);
            
            return nextMonthStart - monthStart;
        }

        function getCanChiNgay(dd, mm, yy) {
            var jd = jdFromDate(dd, mm, yy);
            var canIndex = (jd + 9) % 10;
            var chiIndex = (jd + 1) % 12;
            return { can: CAN[canIndex], chi: CHI[chiIndex], name: CAN[canIndex] + " " + CHI[chiIndex] };
        }

        function getCanChiThangAmLich(thangAmLich, namAmLich) {
            var canNamIndex = (namAmLich + 6) % 10;
            var canThangGiengIndex;
            switch(canNamIndex) {
                case 0: case 5: canThangGiengIndex = 2; break;
                case 1: case 6: canThangGiengIndex = 4; break;
                case 2: case 7: canThangGiengIndex = 6; break;
                case 3: case 8: canThangGiengIndex = 8; break;
                case 4: case 9: canThangGiengIndex = 0; break;
            }
            var canThangIndex = (canThangGiengIndex + thangAmLich - 1) % 10;
            var chiThang = THANG_DIA_CHI[thangAmLich - 1];
            return { can: CAN[canThangIndex], chi: chiThang, name: CAN[canThangIndex] + " " + chiThang };
        }

        // ==================== ORIGINAL DATA SETS ====================
        const hoaGiap = [
            { can: "Gi√°p", chi: "T√Ω", menh: "H·∫£i Trung Kim" }, { can: "·∫§t", chi: "S·ª≠u", menh: "H·∫£i Trung Kim" }, { can: "B√≠nh", chi: "D·∫ßn", menh: "Gi√°ng H·∫° Th·ªßy" }, { can: "ƒêinh", chi: "M√£o", menh: "Gi√°ng H·∫° Th·ªßy" }, { can: "M·∫≠u", chi: "Th√¨n", menh: "ƒê·∫°i L√¢m M·ªôc" }, { can: "K·ª∑", chi: "T·ªµ", menh: "ƒê·∫°i L√¢m M·ªôc" }, { can: "Canh", chi: "Ng·ªç", menh: "L·ªô B√†ng Th·ªï" }, { can: "T√¢n", chi: "M√πi", menh: "L·ªô B√†ng Th·ªï" }, { can: "Nh√¢m", chi: "Th√¢n", menh: "Ki·∫øm Phong Kim" }, { can: "Qu√Ω", chi: "D·∫≠u", menh: "Ki·∫øm Phong Kim" }, { can: "Gi√°p", chi: "Tu·∫•t", menh: "Tuy·ªÅn Trung Th·ªßy" }, { can: "·∫§t", chi: "H·ª£i", menh: "Tuy·ªÅn Trung Th·ªßy" }, { can: "B√≠nh", chi: "T√Ω", menh: "L∆∞ Trung H·ªèa" }, { can: "ƒêinh", chi: "S·ª≠u", menh: "L∆∞ Trung H·ªèa" }, { can: "M·∫≠u", chi: "D·∫ßn", menh: "Th√†nh ƒê·∫ßu Th·ªï" }, { can: "K·ª∑", chi: "M√£o", menh: "Th√†nh ƒê·∫ßu Th·ªï" }, { can: "Canh", chi: "Th√¨n", menh: "B·∫°ch L·∫°p Kim" }, { can: "T√¢n", chi: "T·ªµ", menh: "B·∫°ch L·∫°p Kim" }, { can: "Nh√¢m", chi: "Ng·ªç", menh: "D∆∞∆°ng Li·ªÖu M·ªôc" }, { can: "Qu√Ω", chi: "M√πi", menh: "D∆∞∆°ng Li·ªÖu M·ªôc" }, { can: "Gi√°p", chi: "Th√¢n", menh: "S∆°n ƒê·∫ßu H·ªèa" }, { can: "·∫§t", chi: "D·∫≠u", menh: "S∆°n ƒê·∫ßu H·ªèa" }, { can: "B√≠nh", chi: "Tu·∫•t", menh: "·ªêc Th∆∞·ª£ng Th·ªï" }, { can: "ƒêinh", chi: "H·ª£i", menh: "·ªêc Th∆∞·ª£ng Th·ªï" }, { can: "M·∫≠u", chi: "T√Ω", menh: "Tr∆∞·ªùng L∆∞u Th·ªßy" }, { can: "K·ª∑", chi: "S·ª≠u", menh: "Tr∆∞·ªùng L∆∞u Th·ªßy" }, { can: "Canh", chi: "D·∫ßn", menh: "T√πng B√°ch M·ªôc" }, { can: "T√¢n", chi: "M√£o", menh: "T√πng B√°ch M·ªôc" }, { can: "Nh√¢m", chi: "Th√¨n", menh: "T√≠ch L·ªãch H·ªèa" }, { can: "Qu√Ω", chi: "T·ªµ", menh: "T√≠ch L·ªãch H·ªèa" }, { can: "Gi√°p", chi: "Ng·ªç", menh: "Sa Trung Kim" }, { can: "·∫§t", chi: "M√πi", menh: "Sa Trung Kim" }, { can: "B√≠nh", chi: "Th√¢n", menh: "Thi√™n H√† Th·ªßy" }, { can: "ƒêinh", chi: "D·∫≠u", menh: "Thi√™n H√† Th·ªßy" }, { can: "M·∫≠u", chi: "Tu·∫•t", menh: "B√¨nh ƒê·ªãa M·ªôc" }, { can: "K·ª∑", chi: "H·ª£i", menh: "B√¨nh ƒê·ªãa M·ªôc" }, { can: "Canh", chi: "T√Ω", menh: "B√≠ch Th∆∞·ª£ng Th·ªï" }, { can: "T√¢n", chi: "S·ª≠u", menh: "B√≠ch Th∆∞·ª£ng Th·ªï" }, { can: "Nh√¢m", chi: "D·∫ßn", menh: "Kim B·∫°ch Kim" }, { can: "Qu√Ω", chi: "M√£o", menh: "Kim B·∫°ch Kim" }, { can: "Gi√°p", chi: "Th√¨n", menh: "ƒê·∫°i Kh√™ Th·ªßy" }, { can: "·∫§t", chi: "T·ªµ", menh: "ƒê·∫°i Kh√™ Th·ªßy" }, { can: "B√≠nh", chi: "Ng·ªç", menh: "S∆°n H·∫° H·ªèa" }, { can: "ƒêinh", chi: "M√πi", menh: "S∆°n H·∫° H·ªèa" }, { can: "M·∫≠u", chi: "Th√¢n", menh: "ƒê·∫°i D·ªãch Th·ªï" }, { can: "K·ª∑", chi: "D·∫≠u", menh: "ƒê·∫°i D·ªãch Th·ªï" }, { can: "Canh", chi: "Tu·∫•t", menh: "Thoa Xuy·∫øn Kim" }, { can: "T√¢n", chi: "H·ª£i", menh: "Thoa Xuy·∫øn Kim" }, { can: "Nh√¢m", chi: "T√Ω", menh: "Tang ƒê·ªë M·ªôc" }, { can: "Qu√Ω", chi: "S·ª≠u", menh: "Tang ƒê·ªë M·ªôc" }, { can: "Gi√°p", chi: "D·∫ßn", menh: "Ph√∫c ƒêƒÉng H·ªèa" }, { can: "·∫§t", chi: "M√£o", menh: "Ph√∫c ƒêƒÉng H·ªèa" }, { can: "B√≠nh", chi: "Th√¨n", menh: "Sa Trung Th·ªï" }, { can: "ƒêinh", chi: "T·ªµ", menh: "Sa Trung Th·ªï" }, { can: "M·∫≠u", chi: "Ng·ªç", menh: "ƒê·∫°i H·∫£i Th·ªßy" }, { can: "K·ª∑", chi: "M√πi", menh: "ƒê·∫°i H·∫£i Th·ªßy" }, { can: "Canh", chi: "Th√¢n", menh: "Th·∫°ch L·ª±u M·ªôc" }, { can: "T√¢n", chi: "D·∫≠u", menh: "Th·∫°ch L·ª±u M·ªôc" }, { can: "Nh√¢m", chi: "Tu·∫•t", menh: "Thi√™n Th∆∞·ª£ng H·ªèa" }, { can: "Qu√Ω", chi: "H·ª£i", menh: "Thi√™n Th∆∞·ª£ng H·ªèa" }
        ].map((item, index) => ({ ...item, name: `${item.can} ${item.chi}`, index: index }));
        
        const canAmDuong = { "Gi√°p": "D∆∞∆°ng", "B√≠nh": "D∆∞∆°ng", "M·∫≠u": "D∆∞∆°ng", "Canh": "D∆∞∆°ng", "Nh√¢m": "D∆∞∆°ng", "·∫§t": "√Çm", "ƒêinh": "√Çm", "K·ª∑": "√Çm", "T√¢n": "√Çm", "Qu√Ω": "√Çm" };
        const tienThienCanHanh = { "Gi√°p": "M·ªôc", "·∫§t": "M·ªôc", "B√≠nh": "H·ªèa", "ƒêinh": "H·ªèa", "M·∫≠u": "Th·ªï", "K·ª∑": "Th·ªï", "Canh": "Kim", "T√¢n": "Kim", "Nh√¢m": "Th·ªßy", "Qu√Ω": "Th·ªßy" };
        const hauThienHopPairs = { "Gi√°p": "K·ª∑", "K·ª∑": "Gi√°p", "·∫§t": "Canh", "Canh": "·∫§t", "B√≠nh": "T√¢n", "T√¢n": "B√≠nh", "ƒêinh": "Nh√¢m", "Nh√¢m": "ƒêinh", "M·∫≠u": "Qu√Ω", "Qu√Ω": "M·∫≠u" };
        const hauThienCanHanh = { "Gi√°p": "Th·ªßy", "K·ª∑": "Th·ªßy", "·∫§t": "H·ªèa", "Canh": "H·ªèa", "B√≠nh": "M·ªôc", "T√¢n": "M·ªôc", "ƒêinh": "Kim", "Nh√¢m": "Kim", "M·∫≠u": "Th·ªï", "Qu√Ω": "Th·ªï" };
        
        const menhToHanh = {
            "H·∫£i Trung Kim": "Kim", "Ki·∫øm Phong Kim": "Kim", "B·∫°ch L·∫°p Kim": "Kim", "Sa Trung Kim": "Kim", "Kim B·∫°c Kim": "Kim", "Thoa Xuy·∫øn Kim": "Kim", "Kim B·∫°ch Kim": "Kim",
            "ƒê·∫°i L√¢m M·ªôc": "M·ªôc", "D∆∞∆°ng Li·ªÖu M·ªôc": "M·ªôc", "T√πng B√°ch M·ªôc": "M·ªôc", "B√¨nh ƒê·ªãa M·ªôc": "M·ªôc", "Tang ƒê·ªë M·ªôc": "M·ªôc", "Th·∫°ch L·ª±u M·ªôc": "M·ªôc",
            "Gi√°ng H·∫° Th·ªßy": "Th·ªßy", "Tuy·ªÅn Trung Th·ªßy": "Th·ªßy", "Tr∆∞·ªùng L∆∞u Th·ªßy": "Th·ªßy", "Thi√™n H√† Th·ªßy": "Th·ªßy", "ƒê·∫°i Kh√™ Th·ªßy": "Th·ªßy", "ƒê·∫°i H·∫£i Th·ªßy": "Th·ªßy",
            "L∆∞ Trung H·ªèa": "H·ªèa", "S∆°n ƒê·∫ßu H·ªèa": "H·ªèa", "T√≠ch L·ªãch H·ªèa": "H·ªèa", "S∆°n H·∫° H·ªèa": "H·ªèa", "Ph√∫c ƒêƒÉng H·ªèa": "H·ªèa", "Thi√™n Th∆∞·ª£ng H·ªèa": "H·ªèa",
            "L·ªô B√†ng Th·ªï": "Th·ªï", "Th√†nh ƒê·∫ßu Th·ªï": "Th·ªï", "·ªêc Th∆∞·ª£ng Th·ªï": "Th·ªï", "B√≠ch Th∆∞·ª£ng Th·ªï": "Th·ªï", "ƒê·∫°i D·ªãch Th·ªï": "Th·ªï", "Sa Trung Th·ªï": "Th·ªï"
        };

        const hanhToColors = {
            "H·ªèa": "ƒê·ªè ho·∫∑c V√†ng", "Th·ªßy": "Xanh d∆∞∆°ng, Xanh l∆°, ho·∫∑c Xanh da tr·ªùi",
            "M·ªôc": "Xanh L√° C√¢y ho·∫∑c Xanh n∆∞·ªõc bi·ªÉn", "Th·ªï": "V√†ng, H·ªìng, ho·∫∑c ƒê·ªè", "Kim": "V√†ng ho·∫∑c Xanh n∆∞·ªõc bi·ªÉn"
        };
        
        const diaChiInteractions = { 
            "T√Ω": { nhiHop: "S·ª≠u", tamHop: ["Th√¢n", "Th√¨n"], xung: "Ng·ªç", hai: "M√πi", hinh: "M√£o" }, 
            "S·ª≠u": { nhiHop: "T√Ω", tamHop: ["T·ªµ", "D·∫≠u"], xung: "M√πi", hai: "Ng·ªç", hinh: ["Tu·∫•t", "M√πi"] }, 
            "D·∫ßn": { nhiHop: "H·ª£i", tamHop: ["Ng·ªç", "Tu·∫•t"], xung: "Th√¢n", hai: "T·ªµ", hinh: ["T·ªµ", "Th√¢n"] }, 
            "M√£o": { nhiHop: "Tu·∫•t", tamHop: ["H·ª£i", "M√πi"], xung: "D·∫≠u", hai: "Th√¨n", hinh: "T√Ω" }, 
            "Th√¨n": { nhiHop: "D·∫≠u", tamHop: ["T√Ω", "Th√¢n"], xung: "Tu·∫•t", hai: "M√£o", hinh: "Th√¨n" }, 
            "T·ªµ": { nhiHop: "Th√¢n", tamHop: ["S·ª≠u", "D·∫≠u"], xung: "H·ª£i", hai: "D·∫ßn", hinh: ["D·∫ßn", "Th√¢n"] }, 
            "Ng·ªç": { nhiHop: "M√πi", tamHop: ["D·∫ßn", "Tu·∫•t"], xung: "T√Ω", hai: "S·ª≠u", hinh: "Ng·ªç" }, 
            "M√πi": { nhiHop: "Ng·ªç", tamHop: ["H·ª£i", "M√£o"], xung: "S·ª≠u", hai: "T√Ω", hinh: ["S·ª≠u", "Tu·∫•t"] }, 
            "Th√¢n": { nhiHop: "T·ªµ", tamHop: ["T√Ω", "Th√¨n"], xung: "D·∫ßn", hai: "H·ª£i", hinh: ["D·∫ßn", "T·ªµ"] }, 
            "D·∫≠u": { nhiHop: "Th√¨n", tamHop: ["S·ª≠u", "T·ªµ"], xung: "M√£o", hai: "Tu·∫•t", hinh: "D·∫≠u" }, 
            "Tu·∫•t": { nhiHop: "M√£o", tamHop: ["D·∫ßn", "Ng·ªç"], xung: "Th√¨n", hai: "D·∫≠u", hinh: ["S·ª≠u", "M√πi"] }, 
            "H·ª£i": { nhiHop: "D·∫ßn", tamHop: ["M√£o", "M√πi"], xung: "T·ªµ", hai: "Th√¢n", hinh: "H·ª£i" } 
        };
        
        const nguHanhSinhKhac = { "Kim": { sinh: "Th·ªßy", khac: "M·ªôc" }, "Th·ªßy": { sinh: "M·ªôc", khac: "H·ªèa" }, "M·ªôc": { sinh: "H·ªèa", khac: "Th·ªï" }, "H·ªèa": { sinh: "Th·ªï", khac: "Kim" }, "Th·ªï": { sinh: "Kim", khac: "Th·ªßy" } };
        
        let fullResults = []; 

        // ==================== HELPER FUNCTIONS ====================
        function getHoaGiapByName(name) { return hoaGiap.find(item => item.name === name); }
        
        function getHoaGiapByYear(year) {
            const referenceYear = 1984;
            const index = ((year - referenceYear) % 60 + 60) % 60;
            return hoaGiap[index];
        }
        
        function normalizeChi(chi) { return chi === "T·ªã" ? "T·ªµ" : chi; }
        
        function getInteractionText(hanh1, hanh2) { 
            if (hanh1 === hanh2) return "B√¨nh h√≤a"; 
            if (nguHanhSinhKhac[hanh1]?.sinh === hanh2) return "NƒÉm sinh Tu·ªïi"; 
            if (nguHanhSinhKhac[hanh2]?.sinh === hanh1) return "Tu·ªïi sinh NƒÉm"; 
            if (nguHanhSinhKhac[hanh1]?.khac === hanh2) return "NƒÉm kh·∫Øc Tu·ªïi"; 
            if (nguHanhSinhKhac[hanh2]?.khac === hanh1) return "Tu·ªïi kh·∫Øc NƒÉm"; 
            return "Kh√¥ng t∆∞∆°ng t√°c"; 
        }
        
        function isTamTai(ageChi, yearChi) { 
            const nA = normalizeChi(ageChi), nY = normalizeChi(yearChi);
            const map = { "Th√¢n": ["D·∫ßn", "M√£o", "Th√¨n"], "T√Ω": ["D·∫ßn", "M√£o", "Th√¨n"], "Th√¨n": ["D·∫ßn", "M√£o", "Th√¨n"], 
                "T·ªµ": ["H·ª£i", "T√Ω", "S·ª≠u"], "D·∫≠u": ["H·ª£i", "T√Ω", "S·ª≠u"], "S·ª≠u": ["H·ª£i", "T√Ω", "S·ª≠u"], 
                "D·∫ßn": ["Th√¢n", "D·∫≠u", "Tu·∫•t"], "Ng·ªç": ["Th√¢n", "D·∫≠u", "Tu·∫•t"], "Tu·∫•t": ["Th√¢n", "D·∫≠u", "Tu·∫•t"], 
                "H·ª£i": ["T·ªµ", "Ng·ªç", "M√πi"], "M√£o": ["T·ªµ", "Ng·ªç", "M√πi"], "M√πi": ["T·ªµ", "Ng·ªç", "M√πi"] }; 
            return map[nA] ? map[nA].some(y => normalizeChi(y) === nY) : false;
        }
        
        function isThaiTue(ageChi, yearChi) { return normalizeChi(ageChi) === normalizeChi(yearChi); }
        
        function isXungThaiTue(ageChi, yearChi) {
            const nA = normalizeChi(ageChi), nY = normalizeChi(yearChi);
            const int = diaChiInteractions[nY];
            return int ? normalizeChi(int.xung) === nA : false;
        }
        
        function getBirthYear(ageIndex) {
            const currentYear = new Date().getFullYear();
            let birthYear = 1984 + ageIndex;
            while(birthYear + 60 <= currentYear) birthYear += 60;
            while(birthYear > currentYear) birthYear -= 60;
            return birthYear;
        }

        function getInteractionScoreWithAmDuong(hanh1, hanh2, sign1, sign2) {
            const relation = getInteractionText(hanh1, hanh2);
            const same = sign1 === sign2;
            switch (relation) {
                case "NƒÉm sinh Tu·ªïi": return { score: same ? 10 : 7, text: `NƒÉm sinh Tu·ªïi (${same ? 'c√πng d·∫•u' : 'kh√°c d·∫•u'})` };
                case "B√¨nh h√≤a": return { score: 5, text: "B√¨nh h√≤a" };
                case "Tu·ªïi sinh NƒÉm": return { score: 2, text: "Tu·ªïi sinh NƒÉm" };
                case "NƒÉm kh·∫Øc Tu·ªïi": return { score: same ? 0 : 1, text: `NƒÉm kh·∫Øc Tu·ªïi (${same ? 'c√πng d·∫•u' : 'kh√°c d·∫•u'})` };
                case "Tu·ªïi kh·∫Øc NƒÉm": return { score: 0, text: "Tu·ªïi kh·∫Øc NƒÉm" };
                default: return { score: 0, text: "Kh√¥ng t∆∞∆°ng t√°c" };
            }
        }
        
        // ==================== SCORING FUNCTIONS ====================
        function calculateYearScore(ageData, yearData) {
            const yH = menhToHanh[yearData.menh], aH = menhToHanh[ageData.menh];
            const yS = canAmDuong[yearData.can], aS = canAmDuong[ageData.can];
            
            let total = 0, specials = [];
            const yTT = tienThienCanHanh[yearData.can], aTT = tienThienCanHanh[ageData.can];
            total += getInteractionScoreWithAmDuong(yTT, aTT, yS, aS).score * 3.0;
            
            if (hauThienHopPairs[yearData.can] === ageData.can) { total += 20; }
            else { total += getInteractionScoreWithAmDuong(hauThienCanHanh[yearData.can], hauThienCanHanh[ageData.can], yS, aS).score * 2.0; }
            
            total += getInteractionScoreWithAmDuong(yH, aH, yS, aS).score * 3.0;

            const nA = normalizeChi(ageData.chi), nY = normalizeChi(yearData.chi);
            const int = diaChiInteractions[nY];
            if (int) {
                if (int.tamHop.map(normalizeChi).includes(nA)) total += 20;
                else if (normalizeChi(int.nhiHop) === nA) total += 16;
                else if (normalizeChi(int.xung) === nA || nA === nY) total += 0;
                else if (normalizeChi(int.hai) === nA) total += 2;
                else total += 10;
            }
            
            if (isTamTai(ageData.chi, yearData.chi)) { total *= 0.7; specials.push('tamtai'); }
            if (isThaiTue(ageData.chi, yearData.chi)) { total *= 0.85; specials.push('thaituese'); }
            else if (isXungThaiTue(ageData.chi, yearData.chi)) { total *= 0.85; specials.push('xungthaituese'); }
            
            return { score: total, specials };
        }

        function calculateMonthScore(ageData, monthCanChi) {
            const aS = canAmDuong[ageData.can], mS = canAmDuong[monthCanChi.can];
            let total = 0;
            total += getInteractionScoreWithAmDuong(tienThienCanHanh[monthCanChi.can], tienThienCanHanh[ageData.can], mS, aS).score * 3.0;
            if (hauThienHopPairs[monthCanChi.can] === ageData.can) total += 20;
            else total += getInteractionScoreWithAmDuong(hauThienCanHanh[monthCanChi.can], hauThienCanHanh[ageData.can], mS, aS).score * 2.0;

            const nA = normalizeChi(ageData.chi), nM = normalizeChi(monthCanChi.chi);
            const int = diaChiInteractions[nM];
            if (int) {
                if (int.tamHop.map(normalizeChi).includes(nA)) total += 20;
                else if (normalizeChi(int.nhiHop) === nA) total += 16;
                else if (normalizeChi(int.xung) === nA || nA === nM) total += 0;
                else if (normalizeChi(int.hai) === nA) total += 2;
                else total += 10;
            }
            return total;
        }

        function calculateDayScore(ageData, dayCanChi) {
            const aS = canAmDuong[ageData.can], dS = canAmDuong[dayCanChi.can];
            let total = 0;
            total += getInteractionScoreWithAmDuong(tienThienCanHanh[dayCanChi.can], tienThienCanHanh[ageData.can], dS, aS).score * 3.0;
            if (hauThienHopPairs[dayCanChi.can] === ageData.can) total += 20;
            else total += getInteractionScoreWithAmDuong(hauThienCanHanh[dayCanChi.can], hauThienCanHanh[ageData.can], dS, aS).score * 2.0;

            const nA = normalizeChi(ageData.chi), nD = normalizeChi(dayCanChi.chi);
            const int = diaChiInteractions[nD];
            if (int) {
                if (int.tamHop.map(normalizeChi).includes(nA)) total += 20;
                else if (normalizeChi(int.nhiHop) === nA) total += 16;
                else if (normalizeChi(int.xung) === nA || nA === nD) total += 0;
                else if (normalizeChi(int.hai) === nA) total += 2;
                else total += 10;
            }
            return total;
        }

        // ==================== TAB 1 FUNCTIONS ====================
        function runFullCalculation() {
            if (fullResults.length > 0) return;
            const yearData = getHoaGiapByName(document.getElementById('yearSelect').value);
            if (!yearData) return;
            const yH = menhToHanh[yearData.menh], yS = canAmDuong[yearData.can];
            let allScores = [];

            for (const ageData of hoaGiap) {
                let breakdown = [], isPham = false;
                const aS = canAmDuong[ageData.can];
                
                const tt = getInteractionScoreWithAmDuong(tienThienCanHanh[yearData.can], tienThienCanHanh[ageData.can], yS, aS);
                const tts = tt.score * 3.0;
                breakdown.push(`Can Ti√™n thi√™n: ${tt.text} (+${tts.toFixed(1)}ƒë)`);
                
                let hts = 0;
                if (hauThienHopPairs[yearData.can] === ageData.can) { hts = 20; breakdown.push(`Can H·∫≠u thi√™n: H·ª£p h√≥a (+20.0ƒë)`); }
                else { const ht = getInteractionScoreWithAmDuong(hauThienCanHanh[yearData.can], hauThienCanHanh[ageData.can], yS, aS); hts = ht.score * 2.0; breakdown.push(`Can H·∫≠u thi√™n: ${ht.text} (+${hts.toFixed(1)}ƒë)`); }
                
                const m = getInteractionScoreWithAmDuong(yH, menhToHanh[ageData.menh], yS, aS);
                const ms = m.score * 3.0;
                breakdown.push(`Ng≈© h√†nh M·ªánh: ${m.text} (+${ms.toFixed(1)}ƒë)`);

                let cs = 0, cd = "";
                const nA = normalizeChi(ageData.chi), nY = normalizeChi(yearData.chi);
                const int = diaChiInteractions[nY];
                if (int) {
                    if (int.tamHop.map(normalizeChi).includes(nA)) { cs = 20; cd = "Tam h·ª£p"; }
                    else if (normalizeChi(int.nhiHop) === nA) { cs = 16; cd = "Nh·ªã h·ª£p"; }
                    else if (normalizeChi(int.xung) === nA) { cs = 0; cd = "T∆∞∆°ng Xung"; }
                    else if (nA === nY) { cs = 0; cd = "T∆∞∆°ng H√¨nh"; }
                    else if (normalizeChi(int.hai) === nA) { cs = 2; cd = "T∆∞∆°ng H·∫°i"; }
                    else { cs = 10; cd = "B√¨nh h√≤a"; }
                }
                breakdown.push(`ƒê·ªãa chi: ${cd} (+${cs.toFixed(1)}ƒë)`);

                let total = tts + hts + ms + cs;
                if (isTamTai(ageData.chi, yearData.chi)) { total *= 0.7; breakdown.push(`<span class="penalty">Ph·∫°m Tam Tai (-30%)</span>`); isPham = true; }
                if (isThaiTue(ageData.chi, yearData.chi)) { total *= 0.85; breakdown.push(`<span class="penalty">Ph·∫°m Th√°i Tu·∫ø (-15%)</span>`); isPham = true; }
                else if (isXungThaiTue(ageData.chi, yearData.chi)) { total *= 0.85; breakdown.push(`<span class="penalty">Ph·∫°m Xung Th√°i Tu·∫ø (-15%)</span>`); isPham = true; }
                
                allScores.push({ ...ageData, totalScore: total, isPham, breakdown: `<ul><li>${breakdown.join('</li><li>')}</li></ul>` });
            }
            fullResults = allScores.sort((a, b) => b.totalScore - a.totalScore);
        }
        
        function displayGoodList() { runFullCalculation(); const n = document.getElementById('yearSelect').value; document.getElementById('resultsHeader').innerText = `Top 10 Tu·ªïi T·ªët Nh·∫•t NƒÉm ${n}`; document.getElementById('exportGoodButton').style.display = 'inline-block'; document.getElementById('exportBadButton').style.display = 'none'; renderTable(fullResults.filter(i => !i.isPham).slice(0, 10)); }
        function displayBadList() { runFullCalculation(); const n = document.getElementById('yearSelect').value; document.getElementById('resultsHeader').innerText = `10 Tu·ªïi X·∫•u Nh·∫•t NƒÉm ${n}`; document.getElementById('exportGoodButton').style.display = 'none'; document.getElementById('exportBadButton').style.display = 'inline-block'; renderTable(fullResults.slice(-10).reverse()); }
        function displayAllList() { runFullCalculation(); const n = document.getElementById('yearSelect').value; document.getElementById('resultsHeader').innerText = `B·∫£ng X·∫øp H·∫°ng 60 Hoa Gi√°p NƒÉm ${n}`; document.getElementById('exportGoodButton').style.display = 'none'; document.getElementById('exportBadButton').style.display = 'none'; renderTable(fullResults); }
        function renderTable(data) { const b = document.getElementById('resultsBody'); b.innerHTML = data.length === 0 ? `<tr><td colspan="5" style="text-align:center;">Kh√¥ng c√≥ k·∫øt qu·∫£.</td></tr>` : data.map((i, idx) => `<tr><td class="rank">${idx + 1}</td><td>${i.name}</td><td>${i.menh}</td><td class="score">${i.totalScore.toFixed(2)}</td><td class="details">${i.breakdown}</td></tr>`).join(''); }

        function handleGoodExport() { const t10 = fullResults.filter(i => !i.isPham).slice(0, 10); if (t10.length === 0) return alert("Ch∆∞a c√≥ k·∫øt qu·∫£."); const n = document.getElementById('yearSelect').value, y = getHoaGiapByName(n), c = hanhToColors[menhToHanh[y.menh]] || "ph√π h·ª£p"; let s = `*TU·ªîI X√îNG ƒê·∫§T V√Ä M·ªû H√ÄNG KHAI TR∆Ø∆†NG CHO NƒÇM ${n.toUpperCase()} V·∫¨N KH√ç ${y.menh.toUpperCase()}*\n\nDanh s√°ch 10 tu·ªïi t·ªët nh·∫•t:\n\n`; t10.forEach((i, idx) => { s += `${idx + 1}. ${i.name} (${getBirthYear(i.index)})\n`; }); s += `\nL∆∞u √Ω:\n- Ng∆∞·ªùi x√¥ng ƒë·∫•t m·∫∑c √°o t√¥ng m√†u ${c} l√† thu·∫≠n nh·∫•t.`; document.getElementById('modalHeader').innerText = "K·∫øt Qu·∫£ Tu·ªïi T·ªët"; document.getElementById('exportTextarea').value = s; document.getElementById('exportModal').style.display = "block"; }
        function handleBadExport() { const b10 = fullResults.slice(-10).reverse(); if (b10.length === 0) return alert("Ch∆∞a c√≥ k·∫øt qu·∫£."); const n = document.getElementById('yearSelect').value, y = getHoaGiapByName(n); let s = `*DANH S√ÅCH 10 TU·ªîI X·∫§U NH·∫§T TRONG NƒÇM ${n.toUpperCase()} V·∫¨N KH√ç ${y.menh.toUpperCase()}*\n\n`; b10.forEach((i, idx) => { s += `${idx + 1}. ${i.name} (${getBirthYear(i.index)})\n`; }); document.getElementById('modalHeader').innerText = "K·∫øt Qu·∫£ Tu·ªïi X·∫•u"; document.getElementById('exportTextarea').value = s; document.getElementById('exportModal').style.display = "block"; }

        // ==================== TAB 2 DASHBOARD ====================
        let yearChart = null, monthChart = null, dayChart = null, currentDashboardData = null;
        let reportCharts = [];

        function generateDashboard() {
            const viewYear = parseInt(document.getElementById('dlYearSelect').value);
            const tuoiName = document.getElementById('dlTuoiSelect').value;
            const ageData = getHoaGiapByName(tuoiName);
            if (!ageData) return alert("Kh√¥ng t√¨m th·∫•y th√¥ng tin tu·ªïi!");
            
            const birthYear = getBirthYear(ageData.index);
            const viewYearData = getHoaGiapByYear(viewYear);
            const lunarInfoMid = convertSolar2Lunar(15, 6, viewYear, 7);
            const lunarYear = lunarInfoMid[2];
            
            currentDashboardData = { ageData, viewYear, viewYearData, birthYear, lunarYear };
            
            document.getElementById('dashboardTitle').innerHTML = `ƒê·ªäNH L∆Ø·ª¢NG T∆Ø∆†NG T√ÅC TU·ªîI <strong>${tuoiName}</strong> (${birthYear}) - <strong>${ageData.menh}</strong><br>TRONG NƒÇM <strong>${viewYearData.name}</strong> (${viewYear}) V·∫¨N KH√ç <strong>${viewYearData.menh}</strong>`;
            document.getElementById('dashboardTitle').style.display = 'block';
            
            document.getElementById('summaryCards').innerHTML = `
                <div class="summary-card tuoi"><h4>üéÇ TU·ªîI XEM</h4><div class="value">${ageData.name}</div><div class="sub-info">NƒÉm sinh: ${birthYear} - ${ageData.menh}</div></div>
                <div class="summary-card nam"><h4>üìÖ NƒÇM XEM</h4><div class="value">${viewYearData.name}</div><div class="sub-info">NƒÉm: ${viewYear} - ${viewYearData.menh}</div></div>`;
            document.getElementById('summaryCards').style.display = 'grid';
            
            generateYearChart(ageData, viewYear);
            generateMonthChart(ageData, lunarYear);
            setupDayMonthSelector(lunarYear);
            updateDayChart();
            
            ['yearChartSection', 'monthChartSection', 'dayChartSection'].forEach(id => document.getElementById(id).style.display = 'block');
        }

        function generateYearChart(ageData, centerYear) {
            const years = [], scores = [], bgColors = [], bdColors = [], specials = [];
            for (let i = -3; i <= 3; i++) {
                const y = centerYear + i, yd = getHoaGiapByYear(y), r = calculateYearScore(ageData, yd);
                years.push(`${y}\n${yd.name}`); scores.push(r.score); specials.push(r.specials);
                let bg = 'rgba(52,152,219,0.7)', bd = 'rgba(52,152,219,1)';
                if (r.specials.includes('tamtai')) { bg = 'rgba(231,76,60,0.7)'; bd = 'rgba(231,76,60,1)'; }
                else if (r.specials.includes('thaituese')) { bg = 'rgba(30,132,73,0.7)'; bd = 'rgba(30,132,73,1)'; }
                else if (r.specials.includes('xungthaituese')) { bg = 'rgba(230,126,34,0.7)'; bd = 'rgba(230,126,34,1)'; }
                else if (i === 0) { bg = 'rgba(52,152,219,0.7)'; bd = 'rgba(41,128,185,1)'; }
                bgColors.push(bg); bdColors.push(bd);
            }
            // Highlight current year with thicker border
            const borderWidths = [2,2,2,4,2,2,2];
            if (yearChart) yearChart.destroy();
            yearChart = new Chart(document.getElementById('yearChart').getContext('2d'), {
                type: 'bar', data: { labels: years, datasets: [{ data: scores, backgroundColor: bgColors, borderColor: bdColors, borderWidth: borderWidths, borderRadius: 8 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, tooltip: { callbacks: { afterLabel: ctx => { const s = specials[ctx.dataIndex]; let n = []; if (s.includes('tamtai')) n.push('‚ö†Ô∏è Tam Tai'); if (s.includes('thaituese')) n.push('‚ö†Ô∏è Th√°i Tu·∫ø'); if (s.includes('xungthaituese')) n.push('‚ö†Ô∏è Xung Th√°i Tu·∫ø'); return n.join('\n'); } } }, datalabels: { anchor: 'end', align: 'top', formatter: v => v.toFixed(1), font: { weight: 'bold', size: 12 }, color: '#2c3e50' } }, scales: { y: { beginAtZero: true, max: 100 } } },
                plugins: [ChartDataLabels]
            });
        }

        function generateMonthChart(ageData, lunarYear) {
            const months = [], scores = [], bgColors = [], tooltips = [];
            for (let m = 1; m <= 12; m++) {
                const mc = getCanChiThangAmLich(m, lunarYear), s = calculateMonthScore(ageData, mc);
                months.push(m.toString()); scores.push(s); tooltips.push(mc.name);
                bgColors.push(`hsla(${Math.floor((s/100)*120)},70%,50%,0.7)`);
            }
            if (monthChart) monthChart.destroy();
            monthChart = new Chart(document.getElementById('monthChart').getContext('2d'), {
                type: 'line', data: { labels: months, datasets: [{ data: scores, fill: true, backgroundColor: 'rgba(52,152,219,0.2)', borderColor: 'rgba(52,152,219,1)', borderWidth: 3, tension: 0.4, pointBackgroundColor: bgColors, pointBorderColor: '#fff', pointBorderWidth: 2, pointRadius: 8 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, tooltip: { callbacks: { title: ctx => `Th√°ng ${ctx[0].dataIndex + 1} - ${tooltips[ctx[0].dataIndex]}` } }, datalabels: { anchor: 'end', align: 'top', formatter: v => v.toFixed(1), font: { weight: 'bold', size: 10 }, color: '#2c3e50' } }, scales: { y: { beginAtZero: true, max: 100 }, x: { title: { display: true, text: 'Th√°ng √Çm L·ªãch' } } } },
                plugins: [ChartDataLabels]
            });
        }

        function setupDayMonthSelector(lunarYear) {
            const sel = document.getElementById('dayMonthSelect'); sel.innerHTML = '';
            for (let m = 1; m <= 12; m++) { sel.innerHTML += `<option value="${m}">Th√°ng ${m} √¢m l·ªãch</option>`; }
            sel.value = convertSolar2Lunar(new Date().getDate(), new Date().getMonth() + 1, new Date().getFullYear(), 7)[1];
        }

        function updateDayChart() {
            if (!currentDashboardData) return;
            const { ageData, lunarYear } = currentDashboardData;
            const lm = parseInt(document.getElementById('dayMonthSelect').value), dim = getLunarMonthDays(lm, lunarYear, 7);
            const days = [], scores = [], bgColors = [], tooltips = [];
            for (let d = 1; d <= dim; d++) {
                const sd = convertLunar2Solar(d, lm, lunarYear, 0, 7); if (sd[0] === 0) continue;
                const dc = getCanChiNgay(sd[0], sd[1], sd[2]), s = calculateDayScore(ageData, dc);
                days.push(d.toString()); scores.push(s); tooltips.push({ cc: dc.name, sl: `${sd[0]}/${sd[1]}/${sd[2]}` });
                bgColors.push(`hsla(${Math.floor((s/100)*120)},70%,50%,0.7)`);
            }
            if (dayChart) dayChart.destroy();
            dayChart = new Chart(document.getElementById('dayChart').getContext('2d'), {
                type: 'bar', data: { labels: days, datasets: [{ data: scores, backgroundColor: bgColors, borderWidth: 1, borderRadius: 4 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, tooltip: { callbacks: { title: ctx => `Ng√†y ${ctx[0].dataIndex + 1} - ${tooltips[ctx[0].dataIndex].cc}`, afterTitle: ctx => `(DL: ${tooltips[ctx[0].dataIndex].sl})` } }, datalabels: { anchor: 'end', align: 'top', formatter: v => v.toFixed(0), font: { weight: 'bold', size: 9 }, color: '#2c3e50' } }, scales: { y: { beginAtZero: true, max: 100 }, x: { title: { display: true, text: 'Ng√†y √Çm L·ªãch' }, ticks: { font: { size: 10 } } } } },
                plugins: [ChartDataLabels]
            });
        }

        // ==================== PRINT REPORT ====================
        function openPrintReport() {
            if (!currentDashboardData) return alert("Vui l√≤ng nh·∫•n 'Xem T∆∞∆°ng T√°c' tr∆∞·ªõc!");
            const { ageData, viewYear, viewYearData, birthYear, lunarYear } = currentDashboardData;
            
            // Destroy old charts
            reportCharts.forEach(c => { if (c) c.destroy(); });
            reportCharts = [];
            
            let pagesHTML = '';
            
            // Page 1: Year chart, Month chart, Day chart for month 1
            pagesHTML += `
                <div class="report-page">
                    <div class="report-header">
                        <h1>ƒê·ªäNH L∆Ø·ª¢NG T∆Ø∆†NG T√ÅC TU·ªîI TRONG NƒÇM</h1>
                        <div class="subtitle">Tu·ªïi ${ageData.name} (${birthYear}) - ${ageData.menh} | NƒÉm ${viewYearData.name} (${viewYear}) - ${viewYearData.menh}</div>
                    </div>
                    <div class="report-charts-row" style="flex: 0 0 auto; height: 42%;">
                        <div class="report-chart-half">
                            <div class="report-chart-title">üìä T∆Ø∆†NG T√ÅC 7 NƒÇM</div>
                            <div class="report-legend">
                                <div class="report-legend-item"><span class="report-legend-color" style="background:#e74c3c;"></span> Tam Tai</div>
                                <div class="report-legend-item"><span class="report-legend-color" style="background:#1e8449;"></span> Th√°i Tu·∫ø</div>
                                <div class="report-legend-item"><span class="report-legend-color" style="background:#e67e22;"></span> Xung Th√°i Tu·∫ø</div>
                            </div>
                            <div class="report-chart-container-year"><canvas id="reportYearChart"></canvas></div>
                        </div>
                        <div class="report-chart-half">
                            <div class="report-chart-title">üìà T∆Ø∆†NG T√ÅC 12 TH√ÅNG √ÇM L·ªäCH</div>
                            <div class="report-chart-container-month"><canvas id="reportMonthChart"></canvas></div>
                        </div>
                    </div>
                    <div class="report-chart-full" style="flex: 1; margin-top: 10px;">
                        <div class="report-chart-title">üìÖ T∆Ø∆†NG T√ÅC NG√ÄY TH√ÅNG 1 √ÇM L·ªäCH</div>
                        <div class="report-chart-container-day"><canvas id="reportDayChart1"></canvas></div>
                    </div>
                    <div class="report-footer">B√°o c√°o ƒë∆∞·ª£c t·∫°o b·ªüi Tien.TQN</div>
                </div>
            `;
            
            // Pages 2-6: Day charts for months 2-12 (2 months per page)
            for (let pageNum = 2; pageNum <= 7; pageNum++) {
                const month1 = (pageNum - 2) * 2 + 2;
                const month2 = month1 + 1;
                
                if (month1 > 12) break;
                
                let monthChartsHTML = `
                    <div class="report-day-chart-wrapper">
                        <div class="report-chart-title" style="background: #ecf0f1;">üìÖ T∆Ø∆†NG T√ÅC NG√ÄY TH√ÅNG ${month1} √ÇM L·ªäCH</div>
                        <div class="report-day-chart-inner"><canvas id="reportDayChart${month1}"></canvas></div>
                    </div>
                `;
                
                if (month2 <= 12) {
                    monthChartsHTML += `
                        <div class="report-day-chart-wrapper">
                            <div class="report-chart-title" style="background: #ecf0f1;">üìÖ T∆Ø∆†NG T√ÅC NG√ÄY TH√ÅNG ${month2} √ÇM L·ªäCH</div>
                            <div class="report-day-chart-inner"><canvas id="reportDayChart${month2}"></canvas></div>
                        </div>
                    `;
                }
                
                pagesHTML += `
                    <div class="report-page-secondary">
                        <div class="report-page-header">
                            Tu·ªïi ${ageData.name} (${birthYear}) - ${ageData.menh} | NƒÉm ${viewYearData.name} (${viewYear}) - ${viewYearData.menh}
                        </div>
                        <div class="report-day-charts-container">
                            ${monthChartsHTML}
                        </div>
                        <div class="report-footer">B√°o c√°o ƒë∆∞·ª£c t·∫°o b·ªüi Tien.TQN</div>
                    </div>
                `;
            }
            
            document.getElementById('printReportContent').innerHTML = pagesHTML;
            document.getElementById('printReportModal').style.display = 'block';
            
            setTimeout(() => { generateAllReportCharts(ageData, viewYear, lunarYear); }, 100);
        }

        function generateAllReportCharts(ageData, centerYear, lunarYear) {
            // Year Chart
            const years = [], yScores = [], yBg = [], yBd = [], yBorderWidths = [];
            for (let i = -3; i <= 3; i++) {
                const y = centerYear + i, yd = getHoaGiapByYear(y), r = calculateYearScore(ageData, yd);
                years.push(`${y}\n${yd.name}`); yScores.push(r.score);
                let bg = 'rgba(52,152,219,0.7)', bd = 'rgba(52,152,219,1)', bw = 1;
                if (r.specials.includes('tamtai')) { bg = 'rgba(231,76,60,0.7)'; bd = 'rgba(231,76,60,1)'; }
                else if (r.specials.includes('thaituese')) { bg = 'rgba(30,132,73,0.7)'; bd = 'rgba(30,132,73,1)'; }
                else if (r.specials.includes('xungthaituese')) { bg = 'rgba(230,126,34,0.7)'; bd = 'rgba(230,126,34,1)'; }
                else if (i === 0) { bg = 'rgba(52,152,219,0.7)'; bd = 'rgba(41,128,185,1)'; bw = 3; }
                yBg.push(bg); yBd.push(bd); yBorderWidths.push(bw);
            }
            const reportYearChart = new Chart(document.getElementById('reportYearChart').getContext('2d'), {
                type: 'bar', data: { labels: years, datasets: [{ data: yScores, backgroundColor: yBg, borderColor: yBd, borderWidth: yBorderWidths, borderRadius: 4 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, datalabels: { anchor: 'end', align: 'top', formatter: v => v.toFixed(0), font: { weight: 'bold', size: 9 }, color: '#2c3e50' } }, scales: { y: { beginAtZero: true, max: 100, ticks: { font: { size: 8 } } }, x: { ticks: { font: { size: 7 } } } } },
                plugins: [ChartDataLabels]
            });
            reportCharts.push(reportYearChart);
            
            // Month Chart with tooltips
            const months = [], mScores = [], mBg = [], mTooltips = [];
            for (let m = 1; m <= 12; m++) {
                const mc = getCanChiThangAmLich(m, lunarYear), s = calculateMonthScore(ageData, mc);
                months.push(m.toString()); mScores.push(s); mTooltips.push(mc.name);
                mBg.push(`hsla(${Math.floor((s/100)*120)},70%,50%,0.7)`);
            }
            const reportMonthChart = new Chart(document.getElementById('reportMonthChart').getContext('2d'), {
                type: 'line', data: { labels: months, datasets: [{ data: mScores, fill: true, backgroundColor: 'rgba(52,152,219,0.2)', borderColor: 'rgba(52,152,219,1)', borderWidth: 2, tension: 0.4, pointBackgroundColor: mBg, pointRadius: 5 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, tooltip: { callbacks: { title: ctx => `Th√°ng ${ctx[0].dataIndex + 1} - ${mTooltips[ctx[0].dataIndex]}` } }, datalabels: { anchor: 'end', align: 'top', formatter: v => v.toFixed(0), font: { weight: 'bold', size: 8 }, color: '#2c3e50' } }, scales: { y: { beginAtZero: true, max: 100, ticks: { font: { size: 8 } } }, x: { ticks: { font: { size: 8 } } } } },
                plugins: [ChartDataLabels]
            });
            reportCharts.push(reportMonthChart);
            
            // Day Charts for all 12 months
            for (let lunarMonth = 1; lunarMonth <= 12; lunarMonth++) {
                const canvasId = `reportDayChart${lunarMonth}`;
                const canvas = document.getElementById(canvasId);
                if (!canvas) continue;
                
                const dim = getLunarMonthDays(lunarMonth, lunarYear, 7);
                const days = [], dScores = [], dBg = [], dTooltips = [];
                for (let d = 1; d <= dim; d++) {
                    const sd = convertLunar2Solar(d, lunarMonth, lunarYear, 0, 7); if (sd[0] === 0) continue;
                    const dc = getCanChiNgay(sd[0], sd[1], sd[2]), s = calculateDayScore(ageData, dc);
                    days.push(d.toString()); dScores.push(s);
                    dTooltips.push({ cc: dc.name, sl: `${sd[0]}/${sd[1]}/${sd[2]}` });
                    dBg.push(`hsla(${Math.floor((s/100)*120)},70%,50%,0.7)`);
                }
                const reportDayChart = new Chart(canvas.getContext('2d'), {
                    type: 'bar', data: { labels: days, datasets: [{ data: dScores, backgroundColor: dBg, borderRadius: 2 }] },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, tooltip: { callbacks: { title: ctx => `Ng√†y ${ctx[0].dataIndex + 1} - ${dTooltips[ctx[0].dataIndex].cc}`, afterTitle: ctx => `(DL: ${dTooltips[ctx[0].dataIndex].sl})` } }, datalabels: { anchor: 'end', align: 'top', formatter: v => v.toFixed(0), font: { weight: 'bold', size: 7 }, color: '#2c3e50' } }, scales: { y: { beginAtZero: true, max: 100, ticks: { font: { size: 8 } } }, x: { ticks: { font: { size: 7 } } } } },
                    plugins: [ChartDataLabels]
                });
                reportCharts.push(reportDayChart);
            }
        }

        function closePrintReport() { document.getElementById('printReportModal').style.display = 'none'; }
        function printReport() { window.print(); }

        // ==================== TAB & INIT ====================
        function openTab(evt, tabName) {
            document.querySelectorAll('.tab-content').forEach(t => t.style.display = 'none');
            document.querySelectorAll('.tab-link').forEach(t => t.classList.remove('active'));
            document.getElementById(tabName).style.display = 'block';
            evt.currentTarget.classList.add('active');
        }

        function init() {
            const cy = new Date().getFullYear();
            const ys = document.getElementById('yearSelect');
            hoaGiap.forEach(i => { ys.innerHTML += `<option value="${i.name}">${i.name}</option>`; });
            ys.value = "·∫§t T·ªµ";
            
            const dys = document.getElementById('dlYearSelect');
            for (let y = cy - 10; y <= cy + 10; y++) { const yd = getHoaGiapByYear(y); dys.innerHTML += `<option value="${y}">${y} (${yd.name})</option>`; }
            dys.value = cy;
            
            const dts = document.getElementById('dlTuoiSelect');
            hoaGiap.forEach(i => { dts.innerHTML += `<option value="${i.name}">${i.name} (${getBirthYear(i.index)}) - ${i.menh}</option>`; });
            
            document.getElementById('viewGoodButton').addEventListener('click', displayGoodList);
            document.getElementById('viewBadButton').addEventListener('click', displayBadList);
            document.getElementById('viewAllButton').addEventListener('click', displayAllList);
            document.getElementById('exportGoodButton').addEventListener('click', handleGoodExport);
            document.getElementById('exportBadButton').addEventListener('click', handleBadExport);
            ys.addEventListener('change', () => { fullResults = []; displayGoodList(); });

            const modal = document.getElementById('exportModal');
            document.querySelector('.close-button').onclick = () => modal.style.display = "none";
            window.onclick = e => { if (e.target == modal) modal.style.display = "none"; };
            
            document.querySelector('.tab-link').click();
            displayGoodList();
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
